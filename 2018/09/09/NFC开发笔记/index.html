<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>NFC开发笔记 | Live to change world</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 概述  在正式开始介绍项目前，我想先介绍一下背景及一些废话，方便大家能够更好理解这个项目。这个项目起初是为了能够更好地抓取手机与IC卡之间的交互数据，以及对抓取的数据进行分析。">
<meta name="keywords" content="Android Developer">
<meta property="og:type" content="article">
<meta property="og:title" content="NFC开发笔记">
<meta property="og:url" content="http://www.killshadow.xyz/2018/09/09/NFC开发笔记/index.html">
<meta property="og:site_name" content="Live to change world">
<meta property="og:description" content="0x00 概述  在正式开始介绍项目前，我想先介绍一下背景及一些废话，方便大家能够更好理解这个项目。这个项目起初是为了能够更好地抓取手机与IC卡之间的交互数据，以及对抓取的数据进行分析。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-10-25T06:45:45.507Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NFC开发笔记">
<meta name="twitter:description" content="0x00 概述  在正式开始介绍项目前，我想先介绍一下背景及一些废话，方便大家能够更好理解这个项目。这个项目起初是为了能够更好地抓取手机与IC卡之间的交互数据，以及对抓取的数据进行分析。">
  
    <link rel="alternative" href="/atom.xml" title="Live to change world" type="application/atom+xml">
  
  
    <link rel="icon" href="//assets/img/wolf_track.ico">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
        <a href="/" class="profilepic">
            
            <img lazy-src="/assets/img/head.png" class="js-avatar">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">killshadow</a></h1>
        </hgroup>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="搜索一下" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a  href="http://www.killshadow.xyz/">博客首页</a></li>
                        
                            <li><a  href="/archives">文章归档</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github"  target="_blank" href="https://www.github.com/killshadow" title="github">github</a>
                            
                                <a class="fl zhihu"  target="_blank" href="https://www.zhihu.com/people/0038/" title="zhihu">zhihu</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Android-Developer/" style="font-size: 13.33px;">Android Developer</a> <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Deep-Learning/" style="font-size: 10px;">Deep Learning</a> <a href="/tags/MISC/" style="font-size: 16.67px;">MISC</a> <a href="/tags/Mobile-Security/" style="font-size: 10px;">Mobile Security</a> <a href="/tags/PWN/" style="font-size: 10px;">PWN</a> <a href="/tags/Reverse/" style="font-size: 10px;">Reverse</a> <a href="/tags/Wireless/" style="font-size: 10px;">Wireless</a>
                    </div>
                </section>
                
                
                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">潜心修行，勿忘初心</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">killshadow</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="//assets/img/head.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">killshadow</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="http://www.killshadow.xyz/">博客首页</a></li>
                
                    <li><a href="/archives">文章归档</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://www.github.com/killshadow" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com/people/0038/" title="zhihu">zhihu</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-NFC开发笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/09/09/NFC开发笔记/" class="article-date">
      <time datetime="2018-09-08T16:00:00.000Z" itemprop="datePublished">2018-09-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      NFC开发笔记
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-Developer/">Android Developer</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="x00-概述">0x00 概述</h2>
<blockquote>
<p>在正式开始介绍项目前，我想先介绍一下背景及一些废话，方便大家能够更好理解这个项目。这个项目起初是为了能够更好地抓取手机与IC卡之间的交互数据，以及对抓取的数据进行分析。<a id="more"></a>后来在抓取数据过程当中，希望能够实现某些数据的替换（中间人）、重放、中继，以此展开了一系列的功能扩展。此外，对于数据提取这一块，也做了一些专门的优化，如：在Log中发送数据到HCE模块或者到MitM模块。文章的最后还会对希望扩展的功能进一步分析。我暂且把这个项目的整体设计模式称为：VNNC模式（View Network NFC Control，可以简单理解为MVC模式），对应的包如下图。为了加速apdu数据流的数据传输，我们还增加了多线程功能，这个方式将数据的SQLite存储与apdu数据流分离在不同线程，以保证高效、有序地对数据操作。这个设计模式是鄙人自命名的，如有纰漏，请指正。以下会对整个项目进行解释，以方便接管项目者快速理解整个项目，少走一些弯路。</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── tud</span><br><span class="line">    └── seemuh</span><br><span class="line">        └── nfcgate</span><br><span class="line">            ├── gui</span><br><span class="line">            │   ├── AboutActivity.java</span><br><span class="line">            │   ├── AboutWorkaroundActivity.java</span><br><span class="line">            │   ├── adapter</span><br><span class="line">            │   │   ├── ListViewAdapter.java</span><br><span class="line">            │   │   ├── MitmItemAdapter.java</span><br><span class="line">            │   │   └── MulAdapter.java</span><br><span class="line">            │   ├── EditActivity.java</span><br><span class="line">            │   ├── fragments</span><br><span class="line">            │   │   ├── CloneFragment.java</span><br><span class="line">            │   │   ├── EnablenfcDialog.java</span><br><span class="line">            │   │   ├── HceFragment.java</span><br><span class="line">            │   │   ├── LoggingDetailFragment.java</span><br><span class="line">            │   │   ├── LoggingFragment.java</span><br><span class="line">            │   │   ├── MitmFragment.java</span><br><span class="line">            │   │   ├── RelayFragment.java</span><br><span class="line">            │   │   ├── SettingsFragment.java</span><br><span class="line">            │   │   ├── TokenDialog.java</span><br><span class="line">            │   │   └── WorkaroundDialog.java</span><br><span class="line">            │   ├── LogActivity.java</span><br><span class="line">            │   ├── LoggingDetailActivity.java</span><br><span class="line">            │   ├── MainActivity.java</span><br><span class="line">            │   ├── MitmActivity.java</span><br><span class="line">            │   ├── RuleActivity.java</span><br><span class="line">            │   ├── SettingsActivity.java</span><br><span class="line">            │   ├── Splash.java</span><br><span class="line">            │   ├── tabLayout</span><br><span class="line">            │   │   ├── SlidingTabLayout.java</span><br><span class="line">            │   │   └── SlidingTabStrip.java</span><br><span class="line">            │   └── tabLogic</span><br><span class="line">            │       └── PagerAdapter.java</span><br><span class="line">            ├── network</span><br><span class="line">            │   ├── c2c</span><br><span class="line">            │   │   └── C2C.java</span><br><span class="line">            │   ├── c2s</span><br><span class="line">            │   │   └── C2S.java</span><br><span class="line">            │   ├── Callback.java</span><br><span class="line">            │   ├── HighLevelNetworkHandler.java</span><br><span class="line">            │   ├── HighLevelProtobufHandler.java</span><br><span class="line">            │   ├── LowLevelNetworkHandler.java</span><br><span class="line">            │   ├── LowLevelTCPHandler.java</span><br><span class="line">            │   ├── meta</span><br><span class="line">            │   │   └── MetaMessage.java</span><br><span class="line">            │   └── ProtobufCallback.java</span><br><span class="line">            ├── nfc</span><br><span class="line">            │   ├── config</span><br><span class="line">            │   │   ├── ConfigBuilder.java</span><br><span class="line">            │   │   ├── ConfigOption.java</span><br><span class="line">            │   │   ├── OptionType.java</span><br><span class="line">            │   │   └── Technologies.java</span><br><span class="line">            │   ├── hce</span><br><span class="line">            │   │   ├── ApduService.java</span><br><span class="line">            │   │   ├── DaemonConfiguration.java</span><br><span class="line">            │   │   └── PaymentServiceHost.java</span><br><span class="line">            │   ├── NfcManager.java</span><br><span class="line">            │   └── reader</span><br><span class="line">            │       ├── DesfireWorkaround.java</span><br><span class="line">            │       ├── IsoDepReader.java</span><br><span class="line">            │       ├── NfcAReader.java</span><br><span class="line">            │       ├── NfcBReader.java</span><br><span class="line">            │       ├── NfcFReader.java</span><br><span class="line">            │       ├── NFCTagEmulator.java</span><br><span class="line">            │       ├── NFCTagReader.java</span><br><span class="line">            │       └── NfcVReader.java</span><br><span class="line">            └── util</span><br><span class="line">                ├── CustomTextWatcher.java</span><br><span class="line">                ├── db</span><br><span class="line">                │   ├── CloneListItem.java</span><br><span class="line">                │   ├── CloneListStorage.java</span><br><span class="line">                │   ├── DbInitTask.java</span><br><span class="line">                │   ├── RuleListItem.java</span><br><span class="line">                │   ├── RuleListStorage.java</span><br><span class="line">                │   ├── SessionLoggingContract.java</span><br><span class="line">                │   └── SessionLoggingDbHelper.java</span><br><span class="line">                ├── filter</span><br><span class="line">                │   ├── action</span><br><span class="line">                │   │   ├── Action.java</span><br><span class="line">                │   │   ├── ActionSequence.java</span><br><span class="line">                │   │   ├── Append.java</span><br><span class="line">                │   │   ├── InsertBytes.java</span><br><span class="line">                │   │   ├── ReplaceBytes.java</span><br><span class="line">                │   │   ├── ReplaceContent.java</span><br><span class="line">                │   │   └── Truncate.java</span><br><span class="line">                │   ├── conditional</span><br><span class="line">                │   │   ├── All.java</span><br><span class="line">                │   │   ├── And.java</span><br><span class="line">                │   │   ├── Conditional.java</span><br><span class="line">                │   │   ├── EndsWith.java</span><br><span class="line">                │   │   ├── Equals.java</span><br><span class="line">                │   │   ├── Length.java</span><br><span class="line">                │   │   ├── Not.java</span><br><span class="line">                │   │   ├── Or.java</span><br><span class="line">                │   │   ├── StartsWith.java</span><br><span class="line">                │   │   └── Xor.java</span><br><span class="line">                │   ├── FilterInitException.java</span><br><span class="line">                │   ├── Filter.java</span><br><span class="line">                │   └── FilterManager.java</span><br><span class="line">                ├── ItemBean.java</span><br><span class="line">                ├── MitmComm.java</span><br><span class="line">                ├── NfcComm.java</span><br><span class="line">                ├── NfcSession.java</span><br><span class="line">                ├── preference</span><br><span class="line">                │   └── IntEditTextPreference.java</span><br><span class="line">                ├── ReadLoadedSo.java</span><br><span class="line">                ├── RootManager.java</span><br><span class="line">                ├── RuleMatching.java</span><br><span class="line">                ├── sink</span><br><span class="line">                │   ├── FileSink.java</span><br><span class="line">                │   ├── SessionLoggingSink.java</span><br><span class="line">                │   ├── SinkInitException.java</span><br><span class="line">                │   ├── Sink.java</span><br><span class="line">                │   ├── SinkManager.java</span><br><span class="line">                │   └── TextViewSink.java</span><br><span class="line">                ├── UpdateUI.java</span><br><span class="line">                └── Utils.java</span><br></pre></td></tr></table></figure>
<h2 id="x01-视图模块之fragmentactivity">0x01 视图模块之Fragment/Activity</h2>
<h3 id="adapter">Ⅰ. adapter</h3>
<p>adapter包里又有三个细分的adapter，分别是：<code>ListViewAdapter</code>、<code>MitmItemAdapter</code>、<code>MulAdapter</code>。</p>
<h4 id="listviewadapter">1. ListViewAdapter</h4>
<p>这个Adapter主要是用在<code>HCE</code>模块中的列表的Item，每个Item包含两个<code>EditText</code>和一个<code>Button</code>, 为了能够更好管理<code>EditText</code>和一个<code>Button</code>的相关性, 而增加了这个adapter(适配器). 主要代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">      ViewHolder holder = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">          convertView = LayoutInflater.from(mContext).inflate(R.layout.item_hce_edittext, <span class="keyword">null</span>);</span><br><span class="line">          holder = <span class="keyword">new</span> ViewHolder(convertView);</span><br><span class="line">          convertView.setTag(holder);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          holder = (ViewHolder) convertView.getTag();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> ItemBean itemObj = mData.get(position);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//This is important. Remove TextWatcher first.</span></span><br><span class="line">      <span class="keyword">if</span> (holder.editText1.getTag() <span class="keyword">instanceof</span> TextWatcher) &#123;</span><br><span class="line">          holder.editText1.removeTextChangedListener((TextWatcher) holder.editText1.getTag());</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// 设置读卡器的命令</span></span><br><span class="line">      holder.editText1.setText(itemObj.getReader());</span><br><span class="line">      holder.bt.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">              mData.remove(position);</span><br><span class="line">              <span class="keyword">if</span>(Utils.RuleOrTable)&#123;</span><br><span class="line">                  Utils.currentRule.remove(itemObj.getReader());</span><br><span class="line">                  Utils.ruleAdapter.notifyDataSetChanged();</span><br><span class="line">              &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                  Utils.currentMap.remove(itemObj.getReader());</span><br><span class="line">                  Utils.tableAdapter.notifyDataSetChanged();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      TextWatcher watcher = <span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line">              oldString=s.toString();</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (TextUtils.isEmpty(s)) &#123;</span><br><span class="line">                  itemObj.setReader(<span class="string">""</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  itemObj.setReader(s.toString());</span><br><span class="line">                  <span class="keyword">if</span>(Utils.RuleOrTable)&#123;</span><br><span class="line">                      Utils.currentRule=Utils.ChangeReader(Utils.currentRule,oldString,s.toString());</span><br><span class="line">                  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                      Utils.currentMap=Utils.ChangeReader(Utils.currentMap,oldString,s.toString());</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      holder.editText1.addTextChangedListener(watcher);</span><br><span class="line">      holder.editText1.setTag(watcher);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">//This is important. Remove TextWatcher first.</span></span><br><span class="line">      <span class="keyword">if</span> (holder.editText2.getTag() <span class="keyword">instanceof</span> TextWatcher) &#123;</span><br><span class="line">          holder.editText2.removeTextChangedListener((TextWatcher) holder.editText2.getTag());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      holder.editText2.setText(itemObj.getCard());</span><br><span class="line"></span><br><span class="line">      TextWatcher watcher2 = <span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (TextUtils.isEmpty(s)) &#123;</span><br><span class="line">                  itemObj.setCard(<span class="string">""</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  itemObj.setCard(s.toString());</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">if</span>(Utils.RuleOrTable)&#123;</span><br><span class="line">                      Utils.currentRule=Utils.ChangeCard(Utils.currentRule,itemObj.getReader(),s.toString());</span><br><span class="line">                  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                      Utils.currentMap=Utils.ChangeCard(Utils.currentMap,itemObj.getReader(),s.toString());</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      holder.editText2.addTextChangedListener(watcher2);</span><br><span class="line">      holder.editText2.setTag(watcher2);</span><br><span class="line">      <span class="keyword">return</span> convertView;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>重写<code>getView</code>方法可以从视图中获取当前的ListItem, 并对ListItem进行约束. 上面代码段可看到有个一<code>TextWatcher</code>方法, 这个方法将在<code>CustomTextWatcher.java</code>详细解释.</p>
<h4 id="mitmitemadapter">2. MitmItemAdapter</h4>
<p>这应该是该项目中最复杂的<code>Adapter</code>了, 其中每个Item包含四个<code>Button</code>, 三个<code>TextView</code>, 对应每个<code>Button</code>都有对应的<code>OnclickListener</code> , 根据选中的<code>Button</code>的<code>id</code>来<code>switch</code>, 对应代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">View.OnClickListener mOnClickListener = <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (itemDisable) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (itemButtons) &#123;</span><br><span class="line">                RuleListStorage db = <span class="keyword">new</span> RuleListStorage(mContext);</span><br><span class="line">                List&lt;RuleListItem&gt; items = db.getAll();</span><br><span class="line">                <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> R.id.mitm_list_btn_exec_card:</span><br><span class="line">                        ...</span><br><span class="line">                    <span class="keyword">case</span> R.id.mitm_list_btn_exec_reader:</span><br><span class="line">                        ...</span><br><span class="line">                    <span class="keyword">case</span> R.id.mitm_list_btn_edit:</span><br><span class="line">                        ...</span><br><span class="line">                    <span class="keyword">case</span> R.id.mitm_list_btn_delete:</span><br><span class="line">                        ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如上示代码, <code>v.getId</code>方法对应每个<code>Button</code>的id, 而四个<code>Button</code>都有对<code>RuleListStorage</code>操作, 具体SQLite的介绍在后面会详细解释. 值得注意的是, 上示代码段中引用了两个<code>sychronized</code>, 是为了各个Item在滑动过程中, 保持状态<code>button.setEnable(boolean)</code>. item的状态之所以会发生改变, 是因为adapter的缓存和预浏览机制. 具体原因请google: ArrayAdapter 滑动item状态发生改变.</p>
<p>这里想要细讲的是关于<code>AlertDialog</code>的使用, 这里都是围绕着<code>etBuilder</code>来建立的. <code>AlertDialog</code>的作用是设置一个弹框, 然后把xml对应的组件设置进去. 如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">AlertDialog.Builder etBuilder = <span class="keyword">new</span> AlertDialog.Builder(mContext);</span><br><span class="line"><span class="keyword">final</span> View view = LayoutInflater.from(mContext).inflate(R.layout.dialog_mitm_comm_setting, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">final</span> EditText etName = view.findViewById(R.id.mitm_setting_comm_name);</span><br><span class="line"><span class="keyword">final</span> EditText etReader = view.findViewById(R.id.mitm_setting_reader_comm);</span><br><span class="line"><span class="keyword">final</span> EditText etCard = view.findViewById(R.id.mitm_setting_card_comm);</span><br><span class="line">etReader.addTextChangedListener(<span class="keyword">new</span> CustomTextWatcher(etReader));</span><br><span class="line">etCard.addTextChangedListener(<span class="keyword">new</span> CustomTextWatcher(etCard));</span><br><span class="line">etName.setText(mList.get(position).getName());</span><br><span class="line">etReader.setText(Utils.bytesToHex(mList.get(position).getReaderComm().getData()));</span><br><span class="line">etCard.setText(Utils.bytesToHex(mList.get(position).getCardComm().getData()));</span><br><span class="line">etBuilder.setTitle(<span class="string">"Edit Rule"</span>)</span><br><span class="line">    .setView(view)</span><br><span class="line">    .setCancelable(<span class="keyword">true</span>)</span><br><span class="line">    .setPositiveButton(<span class="string">"Save"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// get data from user, then storage in database</span></span><br><span class="line">            String name = etName.getText().toString();</span><br><span class="line">            String reader = etReader.getText().toString().replace(<span class="string">" "</span>, <span class="string">""</span>);</span><br><span class="line">            String card = etCard.getText().toString().replace(<span class="string">" "</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                Toast.makeText(mContext, <span class="string">"Please input command Function!"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!Utils.isHex(mContext, reader) &amp;&amp; Utils.isHex(mContext, card)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// save in database</span></span><br><span class="line">            RuleListItem ruleListItem = <span class="keyword">new</span> RuleListItem(</span><br><span class="line">                mList.get(position).getId(),</span><br><span class="line">                name,</span><br><span class="line">                <span class="keyword">new</span> NfcComm(NfcComm.Source.HCE, Utils.toBytes(reader)),</span><br><span class="line">                <span class="keyword">new</span> NfcComm(NfcComm.Source.CARD, Utils.toBytes(card))</span><br><span class="line">            );</span><br><span class="line">            RuleListStorage mRuleDb = <span class="keyword">new</span> RuleListStorage(mContext);</span><br><span class="line">            mRuleDb.update(ruleListItem);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// refreshList for list item view</span></span><br><span class="line">            MitmFragment.getInstance().refreshList();</span><br><span class="line"></span><br><span class="line">            notifyDataSetChanged();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// show toast</span></span><br><span class="line">            Toast.makeText(mContext, <span class="string">"Save Successfully!"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">            dialog.dismiss();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">etBuilder.setNegativeButton(<span class="string">"Cancel"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">        dialog.dismiss();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">etBuilder.create();</span><br><span class="line">etBuilder.show();</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<h4 id="muladapter">3. MulAdapter</h4>
<p>这个<code>Adapter</code>比较简单, 只有<code>CheckBox</code>和<code>TextView</code>, 要注意的是, <code>CheckBox</code>在<code>ListView</code>中滑动时, 被勾选的状态也会发生改变(选中之后, 下滑返回选中状态就消失, 原因是<code>public View getView(int position, View convertView, ViewGroup parent)</code>传进来的<code>convertView</code>被多次重用), 这就需要用额外的方法保持被勾选的状态. 解决办法是用<code>HashMap</code>来保存<code>CheckBox</code>的状态值:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;Integer,Boolean&gt; isSelected = <span class="keyword">new</span> HashMap&lt;Integer, Boolean&gt;();</span><br></pre></td></tr></table></figure>
<p>如下方法是从<code>Fragment</code>中传入list之后, 根据list的状态设置<code>CheckBox</code>选中状态.可以视为初始化<code>CheckBox</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MulAdapter中设置此方法.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initCheck</span><span class="params">(List&lt;NfcComm&gt; mlist)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mlist.size(); i++) &#123;</span><br><span class="line">        isSelected.put(i,mlist.get(i).isCheck());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NFCComm中设置此方法.</span></span><br><span class="line"><span class="comment">// checkbox getter and setter</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mCheck;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCheck</span><span class="params">(<span class="keyword">boolean</span> mCheck)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mCheck = mCheck;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LoggingFragment中 ListItem 点击事件的响应, 设置CheckBox的状态</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onListItemClick</span><span class="params">(View v, <span class="keyword">int</span> pos, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// get ViewHolder Object</span></span><br><span class="line">    ViewHolder holder = (ViewHolder)v.getTag();</span><br><span class="line">    <span class="comment">// change checbox status</span></span><br><span class="line">    holder.cb.toggle();</span><br><span class="line">    <span class="comment">// save select state in mEvenList</span></span><br><span class="line">    mEventList.get(pos).setCheck(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// save checkbox selected status</span></span><br><span class="line">  MulAdapter.getIsSelected().put(pos,holder.cb.isChecked());</span><br><span class="line">    <span class="comment">// adjust selected item</span></span><br><span class="line">    <span class="keyword">if</span> (holder.cb.isChecked() == <span class="keyword">true</span>) &#123;</span><br><span class="line">        mCheckNum++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mCheckNum--;</span><br><span class="line">    &#125;</span><br><span class="line">    Toast.makeText(v.getContext(),<span class="string">"Already selected "</span> + mCheckNum</span><br><span class="line">                   + <span class="string">" item."</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="fragment">Ⅱ. Fragment</h3>
<h4 id="clonefragment">1. CloneFragment</h4>
<p>这里的一些监听事件就不细讲, 挑一些重要的讲一下.</p>
<p><code>Fragment</code>与<code>Activity</code>是相辅相成的, 一个<code>Activity</code>可以有多个<code>Fragment</code>, 例如, 该项目中的<code>MainActivity</code>中调用了多个<code>Fragment</code>(具体调用及原理参阅<安卓编程权威指南>第10章), 而<code>Fragment</code>被调用的方式如下:</安卓编程权威指南></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CloneFragment的一个方法, 这个方法被其他class调用, 从而调用该Fragment</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CloneFragment <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(mFragment == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mFragment = <span class="keyword">new</span> CloneFragment();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mFragment;</span><br><span class="line">&#125;</span><br><span class="line">RelayFragment.getInstance();RelayFragment.getInstance();</span><br></pre></td></tr></table></figure>
<p>其中, 发现标签后, 会做如下写数据库操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CloneListStorage storage = <span class="keyword">new</span> CloneListStorage(mContext);</span><br><span class="line">                            storage.add(<span class="keyword">new</span> CloneListItem(RelayFragment.getInstance().mNfcManager.getAnticolData(), value.toString()));</span><br></pre></td></tr></table></figure>
<p>这里从<code>RelayFragment</code>中获取实例后, 再调用该实例里的<code>mNfcManager</code>实例的方法获得卡的UID. 随机UID的方法在接下来数据库操作那里解释.</p>
<h4 id="enablenfcdialog">2. EnablenfcDialog</h4>
<p>这个<code>Dialog</code>在NFC没开启的情况下, 会跳出该<code>Dialog</code>, 提示去系统设置里打开NFC.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在MainActivity中, 继承了EnableNFCDialog, 因此重载了该方法, 并调用了Settings</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNFCDialogPositiveClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// User touched the dialog's goto settings button</span></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Settings.ACTION_NFC_SETTINGS);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="hcefragment">4. HceFragment</h4>
<p>这个<code>Fragment</code>是第四个Tab, 也就是<code>Hce</code>下的视图界面代码, 值得关注的几点有:</p>
<ul>
<li><p>动态申请存储权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityCompat.requestPermissions的方法能够调用申请的dialog</span></span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ActivityCompat.checkSelfPermission(getContext(), Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        ActivityCompat.requestPermissions(getActivity(), PERMISSIONS_STORAGE, REQUEST_PERMISSION_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>动态申请默认支付权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NfcAdapter adapter = NfcAdapter.getDefaultAdapter(getContext());</span><br><span class="line"><span class="comment">// 通过上面实例化一个NFCAdapter之后, 成功获取了CardEmulation实例</span></span><br><span class="line">mCardEmulation = CardEmulation.getInstance(adapter);</span><br><span class="line"><span class="comment">// ComponentName输入的是对应的包名和类</span></span><br><span class="line">ComponentName myComponent = <span class="keyword">new</span> ComponentName(<span class="string">"tud.seemuh.nfcgate"</span>,<span class="string">"tud.seemuh.nfcgate.nfc.hce.ApduService"</span>);</span><br><span class="line"><span class="comment">// 调用CardEmulation的方法</span></span><br><span class="line"><span class="keyword">if</span> (!mCardEmulation.isDefaultServiceForCategory(myComponent, CardEmulation.CATEGORY_PAYMENT)) &#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(CardEmulation.ACTION_CHANGE_DEFAULT);</span><br><span class="line">    intent.putExtra(CardEmulation.EXTRA_CATEGORY, CardEmulation.CATEGORY_PAYMENT);</span><br><span class="line">    intent.putExtra(CardEmulation.EXTRA_SERVICE_COMPONENT, myComponent);</span><br><span class="line">    startActivityForResult(intent, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Log.e(<span class="string">"MainActivityHost"</span>, <span class="string">"on Create: Already default!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>设置Spinner控件的Adapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ArrayAdapter&lt;String&gt; listadapter = <span class="keyword">new</span> ArrayAdapter&lt;String&gt;(getContext(), android.R.layout.simple_spinner_dropdown_item,myFile);</span><br><span class="line">sp.setAdapter(listadapter);</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="loggingdetailfragment">5. LoggingDetailFragment</h4>
<p>这个<code>Fragment</code>是布局Logging数据的视图, 算是一个比较复杂的<code>Fragment</code>了, 将会对如下特性作解释.</p>
<ul>
<li><p>AlertDialog</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AlertDialog <span class="title">getRenameSessionDialog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(getActivity());</span><br><span class="line">    <span class="comment">// Add input value 给TextView添加原本来的Session</span></span><br><span class="line">    <span class="keyword">final</span> EditText input = <span class="keyword">new</span> EditText(getActivity());</span><br><span class="line">    <span class="keyword">if</span> (mSession.getName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        input.setText(mSession.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set up text</span></span><br><span class="line">    builder.setTitle(getText(R.string.title_dialog_rename))</span><br><span class="line">        .setMessage(getText(R.string.rename_dialog_text))</span><br><span class="line">        .setView(input)</span><br><span class="line">        .setIcon(R.drawable.ic_action_edit_title)</span><br><span class="line">        .setPositiveButton(getString(R.string.rename_dialog_confirm), <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">                doSessionRename(input.getText().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    builder.setNegativeButton(getString(R.string.rename_dialog_cancel), <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> builder.create();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这算是一个比较经典的关于弹窗的案例了, <code>AlertDialog.Builder</code>实例化的对象有多种设置组件的方法, 如上面代码所示, 最后调用<code>getRenameSessionDialog.show()</code>即可弹窗.</p></li>
<li><p>AsyncTask</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncSessionLoader</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Long</span>, <span class="title">Void</span>, <span class="title">Cursor</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String TAG = <span class="string">"AsyncSessionLoader"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SQLiteDatabase mDB;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写此方法以在后台线程上执行计算</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Cursor <span class="title">doInBackground</span><span class="params">(Long... longs)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"doInBackground: Started"</span>);</span><br><span class="line">        <span class="comment">// Get a DB object</span></span><br><span class="line">        SessionLoggingDbHelper dbHelper = <span class="keyword">new</span> SessionLoggingDbHelper(getActivity());</span><br><span class="line">        mDB = dbHelper.getReadableDatabase();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Construct query</span></span><br><span class="line">        <span class="comment">// Define Projection</span></span><br><span class="line">        String[] projection = &#123;</span><br><span class="line">            SessionLoggingContract.SessionMeta._ID,</span><br><span class="line">            SessionLoggingContract.SessionMeta.COLUMN_NAME_NAME,</span><br><span class="line">            SessionLoggingContract.SessionMeta.COLUMN_NAME_DATE,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// Define Sort order</span></span><br><span class="line">        String sortorder = SessionLoggingContract.SessionMeta.COLUMN_NAME_DATE + <span class="string">" DESC"</span>;</span><br><span class="line">        <span class="comment">// Define Selection</span></span><br><span class="line">        String selection = SessionLoggingContract.SessionMeta._ID + <span class="string">" LIKE ?"</span>;</span><br><span class="line">        <span class="comment">// Define Selection Arguments</span></span><br><span class="line">        String[] selectionArgs = &#123;String.valueOf(longs[<span class="number">0</span>])&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Perform query</span></span><br><span class="line">        Log.d(TAG, <span class="string">"doInBackground: Performing query"</span>);</span><br><span class="line">        Cursor c = mDB.query(</span><br><span class="line">            SessionLoggingContract.SessionMeta.TABLE_NAME,  <span class="comment">// Target Table</span></span><br><span class="line">            projection,    <span class="comment">// Which fields are we interested in?</span></span><br><span class="line">            selection,     <span class="comment">// Selection clause</span></span><br><span class="line">            selectionArgs, <span class="comment">// Arguments to clause</span></span><br><span class="line">            <span class="keyword">null</span>,          <span class="comment">// Grouping (not desired in this case)</span></span><br><span class="line">            <span class="keyword">null</span>,          <span class="comment">// Filtering (not desired in this case)</span></span><br><span class="line">            sortorder      <span class="comment">// Sort order</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        Log.d(TAG, <span class="string">"doInBackground: Query done, returning"</span>);</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">true&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 必须从应用程序的主线程调用此方法, 上面方法返回的cursor传入下面的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Cursor c)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Move to the first element of the cursor</span></span><br><span class="line">        Log.d(TAG, <span class="string">"onPostExecute: Beginning processing of Sessions"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!c.moveToFirst()) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"onPostExecute: Cursor empty, doing nothing."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// prepare session object</span></span><br><span class="line">        <span class="keyword">long</span> ID = c.getLong(c.getColumnIndexOrThrow(SessionLoggingContract.SessionMeta._ID));</span><br><span class="line">        String name = c.getString(c.getColumnIndexOrThrow(SessionLoggingContract.</span><br><span class="line">                                                          SessionMeta.COLUMN_NAME_NAME));</span><br><span class="line">        String date = c.getString(c.getColumnIndexOrThrow(SessionLoggingContract.</span><br><span class="line">                                                          SessionMeta.COLUMN_NAME_DATE));</span><br><span class="line">        NfcSession session = <span class="keyword">new</span> NfcSession(date, ID, name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update session information</span></span><br><span class="line">        setSessionDetails(session);</span><br><span class="line">        Log.d(TAG, <span class="string">"onPostExecute: Closing connection and finishing"</span>);</span><br><span class="line">        c.close();</span><br><span class="line">        mDB.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里用了UI多线程<a href="https://developer.android.com/reference/android/os/AsyncTask" target="_blank" rel="noopener">AsyncTask</a>的方式从数据库中加载Session的Apdu数据.</p></li>
</ul>
<h4 id="loggingfragment">6. LoggingFragment</h4>
<p>这里的特性跟<code>loggingDetailFragment</code>的差不多, 是Session列表的视图界面, 具体分析不再展开.</p>
<h4 id="mitmfragment">7. MitmFragment</h4>
<p>在RelayFragment中可以跳到这个Fragment, 这里主要的操作也是数据库操作. 如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get data from user, then storage in database</span></span><br><span class="line"><span class="comment">// 这里需要注意的是, 因为调用了CustomTextWatcher, 每一个字节16进制字符串会有一个空格, 因此入库的时候要把空格删掉</span></span><br><span class="line">String name = etName.getText().toString();</span><br><span class="line">String reader = etReader.getText().toString().replace(<span class="string">" "</span>,<span class="string">""</span>);</span><br><span class="line">String card = etCard.getText().toString().replace(<span class="string">" "</span>,<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check input hex format</span></span><br><span class="line"><span class="keyword">if</span> (name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">    Toast.makeText(getActivity(),<span class="string">"Please input command Function!"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!Utils.isHex(mContext, reader) &amp;&amp; Utils.isHex(mContext, card)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// save in database</span></span><br><span class="line">RuleListItem ruleListItem = <span class="keyword">new</span> RuleListItem(</span><br><span class="line">    name,</span><br><span class="line">    <span class="keyword">new</span> NfcComm(NfcComm.Source.HCE,Utils.toBytes(reader)),</span><br><span class="line">    <span class="keyword">new</span> NfcComm(NfcComm.Source.CARD,Utils.toBytes(card))</span><br><span class="line">);</span><br><span class="line">RuleListStorage mRuleDb = <span class="keyword">new</span> RuleListStorage(mContext);</span><br><span class="line">mRuleDb.add(ruleListItem);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add item list</span></span><br><span class="line">refreshList();</span><br><span class="line"></span><br><span class="line">mListAdapter.notifyDataSetChanged();</span><br><span class="line"><span class="comment">// success message show in activity</span></span><br><span class="line">Toast.makeText(getActivity(),<span class="string">"Save Successfully!"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">dialog.dismiss();</span><br></pre></td></tr></table></figure>
<h4 id="relayfragment">8. RelayFragment</h4>
<p>这个Fragment应该是最重要的一个了. 一开始先实例化诸多空间和诸多类, 控制Nerwork/NFC/Database等. 下面将一些方法实现.</p>
<ol type="1">
<li><p>checkIpPort</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// regex for IP checking</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String regexIPpattern =<span class="string">"^(([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.)&#123;3&#125;([01]?\\d\\d?|2[0-4]\\d|25[0-5])$"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> maxPort = <span class="number">65535</span>;</span><br><span class="line">．．．</span><br><span class="line"><span class="comment">// 这个方法是检测IP和port的</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkIpPort</span><span class="params">(String ip, String port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> validPort = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> gotException = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> validIp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 实例化matcher以便根据正则确定是否是合法的IP</span></span><br><span class="line">    Pattern pattern = Pattern.compile(regexIPpattern);</span><br><span class="line">    Matcher matcher = pattern.matcher(ip);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> int_port = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        int_port = Integer.parseInt(port.trim());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        gotException = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!gotException) &#123;</span><br><span class="line">    <span class="comment">// 若在端口范围内, 则validPort置为true</span></span><br><span class="line">        <span class="keyword">if</span> ((int_port &gt; <span class="number">0</span>) &amp;&amp; (int_port &lt;= maxPort)) validPort = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    validIp = matcher.matches();</span><br><span class="line">    <span class="keyword">if</span> (validPort) globalPort = int_port;</span><br><span class="line">    <span class="comment">// 只有port和ip都合法时才返回true</span></span><br><span class="line">    <span class="keyword">return</span> validPort &amp;&amp; validIp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>defineUID</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mFilterManager.rule.setAc(RuleMatching.MitMAction.SelfDefineAnticol);</span><br><span class="line"><span class="keyword">final</span> AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(getContext());</span><br><span class="line"><span class="keyword">final</span> EditText input = <span class="keyword">new</span> EditText(getContext());</span><br><span class="line">input.addTextChangedListener(<span class="keyword">new</span> CustomTextWatcher(input));</span><br><span class="line">builder.setTitle(R.string.pref_define_uid_title)</span><br><span class="line">    .setCancelable(<span class="keyword">true</span>)</span><br><span class="line">    .setMessage(R.string.pref_define_uid_hex)</span><br><span class="line">    .setView(input)</span><br><span class="line">    .setPositiveButton(<span class="string">"Confirm"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">            String UID = input.getText().toString().replace(<span class="string">" "</span>,<span class="string">""</span>);</span><br><span class="line">            <span class="comment">// 检查UID的长度是不是4个字节</span></span><br><span class="line">            <span class="keyword">if</span>(!Utils.isHexAndByte(UID, getContext(),<span class="number">4</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果检查通过则调用Filtermanager里实例化的Rule, 这里对应的是RuleMatching</span></span><br><span class="line">            mFilterManager.rule.setUID(UID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .setNegativeButton(<span class="string">"Cancel"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">builder.create();</span><br><span class="line">builder.show();</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>关于defineUID的有三种UID模式, 分别是: <code>RandomUID</code> <code>SelfDefineUID</code> <code>DefultUID</code>, 分别对应三个case, 上示代码是关于<code>selfdefineUID</code>的代码.</p></li>
<li><p>networkConnectCommon</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">networkConnectCommon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Initialize SinkManager</span></span><br><span class="line">    mSinkManager = <span class="keyword">new</span> SinkManager(mSinkManagerQueue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize FilterManager</span></span><br><span class="line">    mFilterManager = <span class="keyword">new</span> FilterManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pass references</span></span><br><span class="line">    <span class="comment">// 用来存储Apdu数据</span></span><br><span class="line">    mNfcManager.setSinkManager(mSinkManager, mSinkManagerQueue);</span><br><span class="line">    <span class="comment">// 用来过滤Apdu数据</span></span><br><span class="line">    mNfcManager.setFilterManager(mFilterManager);</span><br><span class="line">    <span class="comment">// 用来HighLevelProtobufHandler</span></span><br><span class="line">    mNfcManager.setNetworkHandler(mConnectionClient);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FIXME For debugging purposes, hardcoded selecting of sinks happens here</span></span><br><span class="line">    <span class="comment">// This should be selectable by the user</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize sinks</span></span><br><span class="line">    <span class="comment">// Get Preference manager to determine which sinks are active</span></span><br><span class="line">    SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(getActivity());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine settings for sinks</span></span><br><span class="line">    <span class="keyword">boolean</span> textViewSinkActive   = prefs.getBoolean(getString(R.string.pref_key_debugWindow), <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">boolean</span> logfileSinkActive    = prefs.getBoolean(getString(R.string.pref_key_logfile), <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">boolean</span> logSessionSinkActive = prefs.getBoolean(getString(R.string.pref_key_sessionlogging), <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// try...catch...排错, 存储network中的Apdu</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (textViewSinkActive) &#123;</span><br><span class="line">            <span class="comment">// Debug window is active, activate the sink that collects data for it</span></span><br><span class="line">            mSinkManager.addSink(SinkManager.SinkType.DISPLAY_TEXTVIEW, mDebuginfo, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logfileSinkActive) &#123;</span><br><span class="line">            <span class="comment">// Logging to file is active. Generate filename from timestamp</span></span><br><span class="line">            SimpleDateFormat sdfDate = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>, Locale.US);</span><br><span class="line">            Date now = <span class="keyword">new</span> Date();</span><br><span class="line">            String strDate = sdfDate.format(now);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize File Sink 保存txt log到存储空间</span></span><br><span class="line">            mSinkManager.addSink(SinkManager.SinkType.FILE, strDate + <span class="string">".txt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logSessionSinkActive) &#123;</span><br><span class="line">            mSinkManager.addSink(SinkManager.SinkType.SESSION_LOG, getActivity());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SinkInitException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO Initialize and add Filters</span></span><br><span class="line">    <span class="comment">// Do the actual network connection</span></span><br><span class="line">    mConnectionClient.connect(mIP.getText().toString(), port);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="tablayout-tablogic">Ⅲ. tabLayout &amp; tabLogic</h3>
<h4 id="pageradapter">PagerAdapter</h4>
<p>如果还需要在<code>MainActivity</code>中添加<code>Fragment</code>视图, 可以直接在这个类里添加就好, 修改的地方有三点:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每增加一个Fragment, return的值就+1</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每增加一个Fragment, 就在对应的position返回对应的名称, 以设置名称的值</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CharSequence <span class="title">getPageTitle</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (position == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Relay"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Clone"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Log"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"HCE"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Item "</span> + (position + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每增加一个Fragment, 就根据pos的位置return一个instance.</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (pos) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> RelayFragment.getInstance();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> CloneFragment.getInstance();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> LoggingFragment.getInstance();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> HceFragment.getInstance();</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> RelayFragment.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="activity">Ⅳ. Activity</h3>
<h4 id="aboutworkaroundactivity">1. AboutWorkaroundActivity</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mWebView = (WebView) findViewById(R.id.workaroundDescWebView);</span><br><span class="line"><span class="comment">// Returns the language code of this Locale.</span></span><br><span class="line">String loc = Locale.getDefault().getLanguage();</span><br><span class="line"><span class="comment">// 检索这些资源的底层 AssetManager 存储.</span></span><br><span class="line">AssetManager mg = getResources().getAssets();</span><br><span class="line">String path = <span class="string">"html/desfire-info."</span> + loc + <span class="string">".html"</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    mg.open(path);</span><br><span class="line">    Log.i(TAG, <span class="string">"HTML exists for locale "</span> + loc + <span class="string">", using it."</span>);</span><br><span class="line">    <span class="comment">// mWebView实例加载了该目录下的html</span></span><br><span class="line">    mWebView.loadUrl(<span class="string">"file:///android_asset/"</span> + path);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    Log.i(TAG, <span class="string">"No HTML for locale "</span> + loc + <span class="string">", using default (en)"</span>);</span><br><span class="line">    mWebView.loadUrl(<span class="string">"file:///android_asset/html/desfire-info.en.html"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="editactivity">2. EditActivity</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个Activity主要是在HCE模式下, 用来编辑数据的.</span></span><br><span class="line"><span class="comment">// 从资源中, 获取对应txt的map并放到TextView</span></span><br><span class="line">Map&lt;String,String&gt; myMap= Utils.currentMap;</span><br><span class="line"><span class="keyword">for</span>(Map.Entry&lt;String,String&gt; entry:myMap.entrySet())&#123;</span><br><span class="line">    mData.add(<span class="keyword">new</span> ItemBean(entry.getKey(),entry.getValue()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 给mData listview设置Adapter</span></span><br><span class="line">mAdapter = <span class="keyword">new</span> ListViewAdapter(<span class="keyword">this</span>, mData);</span><br><span class="line">Utils.tableAdapter = mAdapter;</span><br><span class="line">mListView.setAdapter(mAdapter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加控件的监听事件</span></span><br><span class="line">mButton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        mData.add(<span class="keyword">new</span> ItemBean());</span><br><span class="line">        mAdapter.notifyDataSetChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="logactivity">3. LogActivity</h4>
<p>这个Activity用在HCE模式中查看Log的视图界面, 内容较简单, 不再细讲.</p>
<h4 id="mainactivity">4. MainActivity</h4>
<p>这个Activity是控制整个project的枢纽.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里初始化hce hook action</span></span><br><span class="line">DaemonConfiguration.Init(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 这里注册接收器</span></span><br><span class="line">registerReceiver(<span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(context, intent.getStringExtra(<span class="string">"text"</span>), Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="keyword">new</span> IntentFilter(<span class="string">"tud.seemuh.nfcgate.toaster"</span>));</span><br></pre></td></tr></table></figure>
<h4 id="settingactivity">5. SettingActivity</h4>
<p>这个Activity是<code>设置</code>界面的Activity,</p>
<h2 id="x02-network模块">0x02 network模块</h2>
<h3 id="c2cc2smeta">Ⅰ. c2c/c2s/meta</h3>
<p>这三个是根据protobuf序列化之后的类, 不用改, 直接调用就好.</p>
<h3 id="highlevelprotobufhandler">Ⅱ. HighLevelProtobufHandler</h3>
<p><code>HightLevelProtobufhandler</code>是`<code>HighLevelNetworkHandler</code>接口的实现。它用于控制所有的网络通信，并使用一个低级别的网络处理程序来进行实际的网络通信。在这个处理程序和各自的回调实现（在我们的例子中是<code>ProtobufCallBack</code>）中，协议本身被实现。<code>HightLevelProtobufhandler</code>保持网络连接的状态，并负责在连接断开连接时拆卸所有相关的线程，由用户请求或一般连接丢失负责。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态修改Button</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reactivateButtons</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We need to pass a parameter, even though it isn't used. Otherwise, the app will crash.</span></span><br><span class="line">    <span class="keyword">new</span> UpdateUI(connectButton, UpdateUI.UpdateMethod.enableButton).execute(<span class="string">"Unfug"</span>);</span><br><span class="line">    <span class="keyword">new</span> UpdateUI(joinButton, UpdateUI.UpdateMethod.enableButton).execute(<span class="string">"Unfug"</span>);</span><br><span class="line">    <span class="keyword">new</span> UpdateUI(abortButton, UpdateUI.UpdateMethod.disableButton).execute(<span class="string">"Unfug"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setButtonTexts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> UpdateUI(connectButton, UpdateUI.UpdateMethod.setTextButton).execute(MainActivity.createSessionMessage);</span><br><span class="line">    <span class="keyword">new</span> UpdateUI(joinButton, UpdateUI.UpdateMethod.setTextButton).execute(MainActivity.joinSessionMessage);</span><br><span class="line">    <span class="keyword">new</span> UpdateUI(resetButton, UpdateUI.UpdateMethod.setTextButton).execute(MainActivity.resetMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是三个比较重要的函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for reader</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAPDUMessage</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检测是否是apdu数据</span></span><br><span class="line">    <span class="keyword">if</span> (nfcdata.getType() != NfcComm.Type.NFCBytes) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"sendApduMessage: NfcComm object does not contain NFC bytes. Doing nothing."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若reader mode关闭了, 则返回</span></span><br><span class="line">    <span class="keyword">if</span> (status != Status.PARTNER_READER_MODE) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"sendAPDUMessage: Trying to send APDU message to partner who is not in reader mode. Doing nothing."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] apdu = nfcdata.getData();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Prepare message</span></span><br><span class="line">    C2C.NFCData.Builder apduMessage = C2C.NFCData.newBuilder();</span><br><span class="line">    <span class="comment">// 给apduMessage 设置READER属性</span></span><br><span class="line">    apduMessage.setDataSource(C2C.NFCData.DataSource.READER);</span><br><span class="line">    apduMessage.setDataBytes(ByteString.copyFrom(apdu));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send prepared message</span></span><br><span class="line">    sendMessage(apduMessage.build(), MessageCase.NFCDATA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// for card</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAPDUReply</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nfcdata.getType() != NfcComm.Type.NFCBytes) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"sendApduReply: NfcComm object does not contain NFC bytes. Doing nothing."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status != Status.PARTNER_APDU_MODE) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"sendAPDUReply: Trying to send APDU reply to partner who is not in APDU mode. Doing nothing."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] nfcbytes = nfcdata.getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build reply Protobuf</span></span><br><span class="line">    C2C.NFCData.Builder reply = C2C.NFCData.newBuilder();</span><br><span class="line">    reply.setDataBytes(ByteString.copyFrom(nfcbytes));</span><br><span class="line">    <span class="comment">// 设置CARD属性</span></span><br><span class="line">    reply.setDataSource(C2C.NFCData.DataSource.CARD);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send reply</span></span><br><span class="line">    sendMessage(reply.build(), MessageCase.NFCDATA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// it's about uid</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAnticol</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nfcdata.getType() != NfcComm.Type.AnticolBytes) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"sendAnticol: NfcComm object does not contain Anticol bytes. Doing nothing."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Retrieve values</span></span><br><span class="line">    <span class="keyword">byte</span>[] config = nfcdata.getConfig().build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build reply protobuf</span></span><br><span class="line">    C2C.Anticol.Builder b = C2C.Anticol.newBuilder();</span><br><span class="line">    b.setCONFIG(ByteString.copyFrom(config));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO If we aren't in a session, cache this and send it as soon as a session is established?</span></span><br><span class="line">    <span class="comment">// (And delete it if the card is removed in the meantime)</span></span><br><span class="line">    sendMessage(b.build(), MessageCase.ANTICOL);</span><br><span class="line">    Log.d(TAG, <span class="string">"sendAnticol: Sent Anticol message"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lowleveltcphandler">Ⅲ. LowLevelTCPHandler</h3>
<p>该类只发送和接收原始字节，所有的协议逻辑和解析分别发生在HighLevelNetworkHandler或回调实例中。原始数据按照4字节的长度发送数据, 并且通过socket把所有的数据都发送出去. <code>BufferedInputStream</code>为另一个输入流添加功能 - 即缓冲输入和支持mark和reset 方法的能力。当<code>BufferedInputStream</code> 创建时，会创建一个内部缓冲区数组。当流中的字节被读取或跳过时，内部缓冲区将根据需要从所包含的输入流中重新填充，一次处理多个字节。该mark 操作会记住输入流中的一个点，并且该reset操作会导致自从最近mark操作以来，在从所包含的输入流中获取新字节之前重新读取所有字节。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] lenbytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"><span class="keyword">int</span> rcvlen = dis.read(lenbytes);</span><br><span class="line">Log.d(TAG, <span class="string">"Got "</span> + rcvlen + <span class="string">" bytes"</span>);</span><br><span class="line"><span class="keyword">int</span> len = ByteBuffer.wrap(lenbytes).getInt();</span><br><span class="line"></span><br><span class="line"><span class="comment">// read the message data</span></span><br><span class="line"><span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    Log.i(TAG, <span class="string">"Reading bytes of length:"</span> + len);</span><br><span class="line">    readBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">    <span class="keyword">int</span> read = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// read(byte[] b, int off, int len)</span></span><br><span class="line">        <span class="comment">// 将该字节输入流中的字节读入指定的字节数组，从给定的偏移量开始。</span></span><br><span class="line">        read += dis.read(readBytes, read, len-read);</span><br><span class="line">    &#125; <span class="keyword">while</span>(read &lt; len);</span><br><span class="line"></span><br><span class="line">    Log.d(TAG, <span class="string">"Read data: "</span> + Utils.bytesToHex(readBytes));</span><br><span class="line">    <span class="keyword">if</span>(mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"Delegating to Callback."</span>);</span><br><span class="line">        Log.i(<span class="string">"readBytes: "</span>, Utils.bytesToHex(readBytes));</span><br><span class="line">        mCallback.onDataReceived(readBytes);</span><br><span class="line">        Log.d(TAG, <span class="string">"Callback finished execution."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"No callback set, saving for later"</span>);</span><br><span class="line">        getSome = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Log.e(TAG, <span class="string">"Error no postive number of bytes: "</span> + len);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Protocol error: Length information was negative or null"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="protobufcallback">Ⅳ. ProtobufCallback</h3>
<p>这个类里面包含卡和读卡器所有的数据流, 其中最为重要的是<code>handleWrapperMessage</code>这个函数, 如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleWrapperMessage</span><span class="params">(MetaMessage.Wrapper Wrapper)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Determine which type of Message the MetaMessage contains</span></span><br><span class="line">    <span class="keyword">if</span> (Wrapper.getMessageCase() == MessageCase.DATA) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"onDataReceived: MessageCase.DATA: Sending to handler"</span>);</span><br><span class="line">        handleData(Wrapper.getData());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Wrapper.getMessageCase() == MessageCase.NFCDATA) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"onDataReceived: MessageCase:NFCDATA: Sending to handler"</span>);</span><br><span class="line">        handleNFCData(Wrapper.getNFCData());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Wrapper.getMessageCase() == MessageCase.SESSION) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"onDataReceived: MessageCase.SESSION: Sending to handler"</span>);</span><br><span class="line">        handleSession(Wrapper.getSession());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Wrapper.getMessageCase() == MessageCase.STATUS) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"onDataReceived: MessageCase.STATUS: Sending to handler"</span>);</span><br><span class="line">        handleStatus(Wrapper.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Wrapper.getMessageCase() == MessageCase.ANTICOL) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"onDataReceived: MessageCase.ANTICOL: Sending to handler"</span>);</span><br><span class="line">        handleAnticol(Wrapper.getAnticol());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"onDataReceived: Message fits no known case! This is fucked up"</span>);</span><br><span class="line">        Handler.notifyUnknownMessageType();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数根据来自<code>LowLevelNetWorkHandler</code>的数据流, 来对该数据进一步分类, 根据特定的数据类型让特定的函数操作. 例如<code>handleNFCData</code>和<code>handleSession</code>以及<code>handleAnticol</code>. 接下来拿<code>handleNFCData</code>举例分析:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleNFCData</span><span class="params">(C2C.NFCData msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.getDataSource() == C2C.NFCData.DataSource.READER) &#123;</span><br><span class="line">        <span class="comment">// We received a signal FROM a reader device and are required to talk TO a card.</span></span><br><span class="line">        Log.i(TAG,<span class="string">"hangleNFCData: "</span> + Utils.bytesToHex(msg.getDataBytes().toByteArray()));</span><br><span class="line">        NfcComm nfcdata = <span class="keyword">new</span> NfcComm(NfcComm.Source.HCE, msg.getDataBytes().toByteArray());</span><br><span class="line">        mNfcManager.sendToCard(nfcdata);</span><br><span class="line">    &#125; <span class="keyword">else</span>  <span class="keyword">if</span> (msg.getDataSource() == C2C.NFCData.DataSource.CARD) &#123;</span><br><span class="line">        <span class="comment">// We received a signal FROM a card and are required to talk TO a reader.</span></span><br><span class="line">        NfcComm nfcdata = <span class="keyword">new</span> NfcComm(NfcComm.Source.CARD, msg.getDataBytes().toByteArray());</span><br><span class="line">        mNfcManager.sendToReader(nfcdata);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Wait, what? This should be impossible. Are we using an old protocol version?</span></span><br><span class="line">        Log.e(TAG, <span class="string">"HandleNfcData: Received Nfc Data from unknown source =&gt; Not implemented"</span>);</span><br><span class="line">        Handler.notifyNotImplemented();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>msg</code>传入这个函数之后, 再通过<code>if...else if...else</code>对该数据进行分类, 分为<code>card</code>的数据和<code>reader</code>的数据. 最后再通过<code>sendToCard</code> 和 <code>sendRoReader</code> 函数对这些数据分流, 这两个函数在<code>NFCManager.java</code>会介绍.</p>
<h2 id="x03-nfc模块">0x03 nfc模块</h2>
<h3 id="config">Ⅰ. config</h3>
<ol type="1">
<li><p><strong>ConfigBuilder</strong></p>
<p>这是一个将<code>anticol</code>进行数据格式的转换的类. 其中包含两个重要的函数<code>parse</code>和<code>build</code>, 如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个函数会将config数据(也就是Hce手机端接受的第一条来自card的数据)根据特定的数据类型转换为可读的有意义的数据.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(<span class="keyword">byte</span>[] config)</span> </span>&#123;</span><br><span class="line">    mOptions.clear();</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(index + <span class="number">2</span> &lt; config.length) &#123;</span><br><span class="line">        <span class="keyword">byte</span> type = config[index + <span class="number">0</span>];</span><br><span class="line">        <span class="keyword">byte</span> length = config[index + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">        System.arraycopy(config, index + <span class="number">2</span>, data, <span class="number">0</span>, length);</span><br><span class="line"></span><br><span class="line">        add(OptionType.fromType(type), data);</span><br><span class="line">        index += length + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个函数是上一个函数的逆函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] build() &#123;</span><br><span class="line">    <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ConfigOption option : mOptions)</span><br><span class="line">        length += option.len() + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">    <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ConfigOption option : mOptions) &#123;</span><br><span class="line">        option.push(data, offset);</span><br><span class="line">        offset += option.len() + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个函数讲格式化之后的字符串拼接起来, 返回给调用者</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ConfigOption option : mOptions)</span><br><span class="line">        result.append(option.toString());</span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>ConfigOption</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个函数被上示代码中的toString函数调用</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">true<span class="comment">// 这里根据特定的数据, 给定特定的名称.</span></span><br><span class="line">    result.append(<span class="string">"Type: "</span>);</span><br><span class="line">    result.append(mID.toString());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mData.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        result.append(<span class="string">" ("</span>);</span><br><span class="line">        result.append(mData.length);</span><br><span class="line">        result.append(<span class="string">")"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result.append(<span class="string">", Value: 0x"</span>);</span><br><span class="line">    result.append(bytesToHex(mData));</span><br><span class="line">    result.append(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>OptionType</strong></p>
<p>这是一个枚举类, 为上示<code>parse</code>函数提供解析.</p></li>
</ol>
<h3 id="hce">Ⅱ. hce</h3>
<ol type="1">
<li><p><strong>ApduService</strong></p>
<p>这个类是与底层lib交互apdu命令最终要的一个类, 其中重要的函数有<code>processCommandApdu</code>、<code>onDeactivated</code>、<code>sendResponse</code>等:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] processCommandApdu(<span class="keyword">byte</span>[] apdu, Bundle extras) &#123;</span><br><span class="line">    Log.d(TAG, <span class="string">"APDU-IN: "</span> + Utils.bytesToHex(apdu));</span><br><span class="line">    <span class="comment">// 这里需要留意的是, 只有当滑动到HCE界面的时候(即mCurrent==3), 才让其返回handleApdu的值</span></span><br><span class="line">    <span class="keyword">if</span> (SlidingTabLayout.mCurrentPos == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> handleApdu(getApplicationContext(), apdu);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Package the ADPU into a NfcComm object</span></span><br><span class="line">    NfcComm nfcdata = <span class="keyword">new</span> NfcComm(NfcComm.Source.HCE, apdu);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send the object to the handler</span></span><br><span class="line">    mNfcManager.handleHCEData(nfcdata);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell the HCE implementation to wait a moment</span></span><br><span class="line">    <span class="keyword">return</span> DONT_RESPOND;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数传入的<code>byte[] apdu</code>就是来自卡的apdu命令, 而return的<code>byte[]</code>就是手机返回给卡的数据.</p>
<p>期间, 对输入进来的数据进行实例化之后, 通过<code>handleHCEData</code>函数处理.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个函数当读卡器断开交易的时候被调用</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDeactivated</span><span class="params">(<span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (SlidingTabLayout.mCurrentPos == <span class="number">3</span>) &#123;</span><br><span class="line">        Utils.tv.append(<span class="string">"-------------------------------------End-------------------------------------\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mNfcManager.unsetApduService();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// sendResponseApdu函数是返回给卡的一个函数, 其功能相当于processCommandApdu的返回值</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendResponse</span><span class="params">(<span class="keyword">byte</span>[] apdu)</span> </span>&#123;</span><br><span class="line">    Log.d(TAG, <span class="string">"APDU-OUT: "</span> + Utils.bytesToHex(apdu));</span><br><span class="line">    sendResponseApdu(apdu);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个函数用在hce功能的时候, 其中处理逻辑都在Utils类中.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">byte</span>[] handleApdu(Context context, <span class="keyword">byte</span>[] apdu) &#123;</span><br><span class="line">    Utils.tv.append(<span class="string">"pos:\n"</span>+Utils.bytesToHex(apdu)+<span class="string">"\n\n"</span>);</span><br><span class="line">    String payload =  Utils.Start(context,apdu);</span><br><span class="line">    Log.i(TAG,<span class="string">"payload: "</span> + payload);</span><br><span class="line">    Utils.tv.append(<span class="string">"card:\n"</span>+payload+<span class="string">"\n\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> Utils.toBytes(payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>DaemonConfiguration</strong></p>
<p>这个类在<code>MainActivity</code>被调用, 这里会根据<code>Action</code>发送<code>Broadcast</code>.</p></li>
</ol>
<h3 id="reader">Ⅲ. reader</h3>
<p>这里根据卡的类型选择特定的类返回相应的命令, 各种卡标签的识别是建立在继承<code>NFCTagReader</code>这个接口上的.</p>
<h3 id="nfcmanager">Ⅳ. NfcManager</h3>
<p>这是格式化apdu数据最重要的一个类, 定义了apdu的各种属性.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> NfcComm <span class="title">handleHceDataCommon</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    Log.d(TAG, <span class="string">"handleHceDataCommon: Pre-Filter: "</span> +</span><br><span class="line">          Utils.bytesToHex(nfcdata.getData()));</span><br><span class="line">    <span class="keyword">if</span> (mFilterManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        nfcdata = mFilterManager.filterHCEData(nfcdata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notifySinkManager(nfcdata);</span><br><span class="line"></span><br><span class="line">    Log.d(TAG, <span class="string">"handleHceDataCommon: Post-Filter: "</span> +</span><br><span class="line">          Utils.bytesToHex(nfcdata.getData()));</span><br><span class="line">    <span class="keyword">return</span> nfcdata;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> NfcComm <span class="title">handleCardDataCommon</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    Log.d(TAG, <span class="string">"handleCardDataCommon: Pre-Filter: "</span> +</span><br><span class="line">          Utils.bytesToHex(nfcdata.getData()));</span><br><span class="line">    <span class="keyword">if</span> (mFilterManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        nfcdata = mFilterManager.filterCardData(nfcdata);</span><br><span class="line">    &#125;</span><br><span class="line">    notifySinkManager(nfcdata);</span><br><span class="line"></span><br><span class="line">    Log.d(TAG, <span class="string">"handleCardDataCommon: Post-Filter: "</span> +</span><br><span class="line">          Utils.bytesToHex(nfcdata.getData()));</span><br><span class="line">    <span class="keyword">return</span> nfcdata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面两个函数, 分辨是handle <code>card</code> <code>reader</code> 的函数, 其中最为重要的是<code>filterCardData</code> <code>filterHCEData</code>两个函数, 其中中间人数据就是在<code>filterCardData</code> <code>filterHCEData</code>两个方法里被篡改的. 函数的实现在后面<code>RuleMatching.java</code>会介绍.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">true<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send NFC data to the card</span></span><br><span class="line"><span class="comment">     * 这里主要将HCE手机的来自读卡器的apdu通过network发给另一部手机.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nfcdata NFcComm object containing the message for the card</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendToCard</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mReader.isConnected()) &#123;</span><br><span class="line">        nfcdata = handleHceDataCommon(nfcdata);</span><br><span class="line">        Log.i(TAG,<span class="string">"sendToCard: "</span> + Utils.bytesToHex(nfcdata.getData()));</span><br><span class="line">        <span class="comment">// Communicate with card</span></span><br><span class="line">        <span class="keyword">byte</span>[] reply = mReader.sendCmd(nfcdata.getData());</span><br><span class="line">        <span class="keyword">if</span> (reply == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mReader.closeConnection();</span><br><span class="line">            mNetworkHandler.disconnectCardWorkaround();</span><br><span class="line">            mNetworkHandler.notifyNFCNotConnected();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Create NfcComm object and pass it through filter and sinks</span></span><br><span class="line">            NfcComm nfcreply = <span class="keyword">new</span> NfcComm(NfcComm.Source.CARD, reply);</span><br><span class="line">            nfcreply = handleCardDataCommon(nfcreply);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Send message</span></span><br><span class="line">            mNetworkHandler.sendAPDUReply(nfcreply);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"HandleNFCData: No NFC connection active"</span>);</span><br><span class="line">        <span class="comment">// There is no connected NFC device</span></span><br><span class="line">        mNetworkHandler.notifyNFCNotConnected();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send NFC data to the Reader</span></span><br><span class="line"><span class="comment">     * 这里主要将普通手机读取的来自卡的apdu发给HCE进而发给读卡器.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nfcdata NfcComm object containing the message for the Reader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendToReader</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mApduService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Pass data through sinks and filters</span></span><br><span class="line">        nfcdata = handleCardDataCommon(nfcdata);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Send data to the Reader device</span></span><br><span class="line">        Log.i(TAG,<span class="string">"sendToReader: "</span> + Utils.bytesToHex(nfcdata.getData()));</span><br><span class="line">        mApduService.sendResponse(nfcdata.getData());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"HandleNFCData: Received a message for a reader, but no APDU instance active."</span>);</span><br><span class="line">        mNetworkHandler.notifyNFCNotConnected();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="x04-util">0x04 util</h2>
<h3 id="db">Ⅰ. db</h3>
<h4 id="cloneliststorage">1. CloneListStorage</h4>
<p><code>CloneListItem</code>是定义数据库每个<code>Item</code>数据结构的一个类, 其实现并不复杂, 不再赘述. 接下来看<code>CloneListStorage</code>:</p>
<ol type="1">
<li><p>首先定义数据库名称及各列的列名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// All Static variables</span></span><br><span class="line"><span class="comment">// Database Version</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATABASE_VERSION = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Database Name</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_NAME = <span class="string">"clonemode.db"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// table name</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TABLE_NAME = <span class="string">"list"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Table Columns names</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_ID = <span class="string">"id"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_NAME = <span class="string">"name"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_CONFIG = <span class="string">"config"</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>然后建立数据库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果要调用或者建立这个数据库, 传入一个context即可新建/获得这个数据库.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CloneListStorage</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context, DATABASE_NAME, <span class="keyword">null</span>, DATABASE_VERSION);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里重写了onCreate方法, 是产生相应的table. 注意下列字符串定义了每个table的数据类型 </span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</span><br><span class="line">    String CREATE_CONTACTS_TABLE = <span class="string">"CREATE TABLE "</span> + TABLE_NAME + <span class="string">"("</span></span><br><span class="line">        + KEY_ID + <span class="string">" INTEGER PRIMARY KEY,"</span></span><br><span class="line">        + KEY_NAME + <span class="string">" TEXT,"</span></span><br><span class="line">        + KEY_CONFIG + <span class="string">" BLOB"</span></span><br><span class="line">        + <span class="string">")"</span>;</span><br><span class="line">    db.execSQL(CREATE_CONTACTS_TABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>如果要往database添加item, 如下函数可实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(CloneListItem item)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 实例化一个可写的SQLiteDatabase</span></span><br><span class="line">    SQLiteDatabase db = <span class="keyword">this</span>.getWritableDatabase();</span><br><span class="line">    <span class="comment">// 实例化一个ContentValues, 以给对应的table赋值</span></span><br><span class="line">    ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">    <span class="comment">// 首先给KEY_NAME赋值, 也就是item的名称</span></span><br><span class="line">    values.put(KEY_NAME, item.toString());</span><br><span class="line">    <span class="comment">// 获得anticol的值之后, 再build成blob类型</span></span><br><span class="line">    NfcComm ac = item.getAnticolData();</span><br><span class="line">    values.put(KEY_CONFIG, ac.getConfig().build());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inserting Row 插入数据库中</span></span><br><span class="line">    db.insert(TABLE_NAME, <span class="keyword">null</span>, values);</span><br><span class="line">    db.close(); <span class="comment">// Closing database connection</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>在<code>CLONE</code>界面里的自定义UID就是在这里实现的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当数据库里的Defult没有时, 则会调用这个函数生成一个默认的item, 以后产生随机UID或者自定义UID都是在这个item里作修改.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDefultConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SQLiteDatabase db = <span class="keyword">this</span>.getWritableDatabase();</span><br><span class="line">    <span class="comment">// 这里用的是rawQueray, 可以直接用命令选择相应的list</span></span><br><span class="line">    Cursor c = db.rawQuery(<span class="string">"select * from list"</span>,<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (c.getCount() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        String defultAnticol = <span class="string">"330477AD15D532012830010831010059024744"</span>;</span><br><span class="line">        Log.i(<span class="string">"***DefultAnticol: "</span>, defultAnticol);</span><br><span class="line">        ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">        values.put(KEY_NAME, <span class="string">"Defult"</span>);</span><br><span class="line">        values.put(KEY_ID, <span class="number">1</span>);</span><br><span class="line">        values.put(KEY_CONFIG, Utils.toBytes(defultAnticol));</span><br><span class="line">        db.insert(TABLE_NAME, <span class="keyword">null</span>, values);</span><br><span class="line">    &#125;</span><br><span class="line">    db.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeUID</span><span class="params">(String UID)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Utils.isHex(UID)) &#123;</span><br><span class="line">        SQLiteDatabase db = <span class="keyword">this</span>.getWritableDatabase();</span><br><span class="line">        ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">        values.put(KEY_CONFIG,</span><br><span class="line">                  Utils.toBytes(</span><br><span class="line">                      <span class="string">"3304"</span>+UID+<span class="string">"32012830010831010059024744"</span>));</span><br><span class="line">        <span class="comment">// Default item总是在数据库的第一个.</span></span><br><span class="line">        db.update(</span><br><span class="line">            TABLE_NAME,</span><br><span class="line">            values,</span><br><span class="line">            KEY_ID + <span class="string">" = ?"</span>,</span><br><span class="line">            <span class="keyword">new</span> String[]&#123;<span class="string">"1"</span>&#125;</span><br><span class="line">        );</span><br><span class="line">        db.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>删除item操作如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以看出, 是根据id(数据库的第几项)来删除item的</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    SQLiteDatabase db = <span class="keyword">this</span>.getWritableDatabase();</span><br><span class="line">    db.delete(TABLE_NAME, KEY_ID + <span class="string">" = ?"</span>,</span><br><span class="line">              <span class="keyword">new</span> String[]&#123;String.valueOf(id)&#125;);</span><br><span class="line">    db.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>获得数据库所有的item:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;CloneListItem&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;CloneListItem&gt; contactList = <span class="keyword">new</span> ArrayList&lt;CloneListItem&gt;();</span><br><span class="line">    <span class="comment">// Select All Query</span></span><br><span class="line">    String selectQuery = <span class="string">"SELECT  * FROM "</span> + TABLE_NAME;</span><br><span class="line"></span><br><span class="line">    SQLiteDatabase db = <span class="keyword">this</span>.getWritableDatabase();</span><br><span class="line">    Cursor cursor = db.rawQuery(selectQuery, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// looping through all rows and adding to list</span></span><br><span class="line">    <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            contactList.add(createByCursor(cursor));</span><br><span class="line">        &#125; <span class="keyword">while</span> (cursor.moveToNext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return contact list</span></span><br><span class="line">    <span class="keyword">return</span> contactList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="ruleliststorage">2. RuleListStorage</h4>
<p>这里其实跟<code>CloneListStorage</code>很相似, 将一个比较不一样的例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个函数遍历整个数据库, 然后获取每个item的state值, 可能为0,1,2, 分别表示: 未选中, 修改卡返回的apdu数据, 修改读卡器的apdu数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;Integer, Integer&gt; <span class="title">getStateMap</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Map&lt;Integer, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    SQLiteDatabase db = <span class="keyword">this</span>.getReadableDatabase();</span><br><span class="line">    String selectQuery = <span class="string">"SELECT * FROM "</span> + TABLE_NAME;</span><br><span class="line">    Cursor c = db.rawQuery(selectQuery,<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (c.moveToFirst()) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            map.put(c.getInt(c.getColumnIndex(KEY_ID)),</span><br><span class="line">                    c.getInt(c.getColumnIndex(KEY_SELECT_STATE)));</span><br><span class="line">        &#125;<span class="keyword">while</span> (c.moveToNext());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="sessionloggingdbhelper">3. SessionLoggingDbHelper</h4>
<p>这个类存储卡和读卡器的apdu数据.</p>
<h3 id="filter">Ⅱ. filter</h3>
<p>这里是过滤一些不规范的apdu数据, 下面只分析部分<code>FilterManager</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">true<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute filters that are registered for HCE data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nfcdata The APDU that should be filtered</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The filtered HCE data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> NfcComm <span class="title">filterHCEData</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里根据RuleListStorage的规则识别一些来自读卡器的apdu指令，以便对其做进一步操作</span></span><br><span class="line">    rule.changeHCEData(nfcdata);</span><br><span class="line">    <span class="keyword">if</span> (mHCENonEmpty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nfcdata.getType() != NfcComm.Type.NFCBytes) <span class="keyword">return</span> nfcdata;</span><br><span class="line">        <span class="keyword">for</span> (Filter f : mHCEFilters) &#123;</span><br><span class="line">            nfcdata = f.filter(nfcdata);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nfcdata;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">true<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute filters that are registered for Card data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nfcdata The APDU that should be filtered</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The filtered Card data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> NfcComm <span class="title">filterCardData</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里根据上面识别的来自读卡器的apdu指令，对卡返回的数据进行修改</span></span><br><span class="line">    rule.changeCardData(nfcdata);</span><br><span class="line">    <span class="keyword">if</span> (mCardNonEmpty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nfcdata.getType() != NfcComm.Type.NFCBytes) <span class="keyword">return</span> nfcdata;</span><br><span class="line">        <span class="keyword">for</span> (Filter f : mCardFilters) &#123;</span><br><span class="line">            nfcdata = f.filter(nfcdata);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nfcdata;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">true<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute filters that are registered for Anticollision data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> anticol NfcComm object containing anticol data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> NfcComm <span class="title">filterAnticolData</span><span class="params">(NfcComm anticol)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 修改UID也是在这里开始的</span></span><br><span class="line">    anticol = rule.changeAnticolData(anticol);</span><br><span class="line">    <span class="keyword">if</span> (mAnticolNonEmpty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (anticol.getType() != NfcComm.Type.AnticolBytes) <span class="keyword">return</span> anticol;</span><br><span class="line">        <span class="keyword">for</span> (Filter f : mAnticolFilters) &#123;</span><br><span class="line">            anticol = f.filter(anticol);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> anticol;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他">Ⅲ. 其他</h3>
<h4 id="customtextwatcher">1. CustomTextWatcher</h4>
<p><code>TextWatcher</code>有三个重要的方法, 顾名思义分别是TextView在改变前/改变时/改变后的动作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在改变前没有做任何修改</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> start,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里限定了输入时只能输入16进制字符, 而且每两个字符之间像个一个空格</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> start, <span class="keyword">int</span> before,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String temp = charSequence.toString();</span><br><span class="line">        <span class="comment">// Set selection.</span></span><br><span class="line">        <span class="keyword">if</span> (mLastText.equals(temp)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mInvalid) &#123;</span><br><span class="line">                mSelection -= <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((mSelection &gt;= <span class="number">1</span>) &amp;&amp; (temp.length() &gt; mSelection - <span class="number">1</span>)</span><br><span class="line">                    &amp;&amp; (temp.charAt(mSelection - <span class="number">1</span>)) == <span class="string">' '</span>) &#123;</span><br><span class="line">                    mSelection += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> length = mLastText.length();</span><br><span class="line">            <span class="keyword">if</span> (mSelection &gt; length) &#123;</span><br><span class="line"></span><br><span class="line">                mEditText.setSelection(length);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                mEditText.setSelection(mSelection);</span><br><span class="line">            &#125;</span><br><span class="line">            mFormat = <span class="keyword">false</span>;</span><br><span class="line">            mInvalid = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mFormat = <span class="keyword">true</span>;</span><br><span class="line">        mSelection = start;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Delete operation.</span></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((mSelection &gt;= <span class="number">1</span>) &amp;&amp; (temp.length() &gt; mSelection - <span class="number">1</span>)</span><br><span class="line">                &amp;&amp; (temp.charAt(mSelection - <span class="number">1</span>)) == <span class="string">' '</span>) &#123;</span><br><span class="line">                mSelection -= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Input operation.</span></span><br><span class="line">        mSelection += count;</span><br><span class="line">        <span class="keyword">char</span>[] lastChar = (temp.substring(start, start + count))</span><br><span class="line">            .toCharArray();</span><br><span class="line">        <span class="keyword">int</span> mid = lastChar[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (mid &gt;= <span class="number">48</span> &amp;&amp; mid &lt;= <span class="number">57</span>) &#123;</span><br><span class="line">            <span class="comment">/* 1-9. */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mid &gt;= <span class="number">65</span> &amp;&amp; mid &lt;= <span class="number">70</span>) &#123;</span><br><span class="line">            <span class="comment">/* A-F. */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mid &gt;= <span class="number">97</span> &amp;&amp; mid &lt;= <span class="number">102</span>) &#123;</span><br><span class="line">            <span class="comment">/* a-f. */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* Invalid input. */</span></span><br><span class="line">            mInvalid = <span class="keyword">true</span>;</span><br><span class="line">            temp = temp.substring(<span class="number">0</span>, start)</span><br><span class="line">                + temp.substring(start + count, temp.length());</span><br><span class="line">            mEditText.setText(temp);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.i(TAG, e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable editable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/* Format input. */</span></span><br><span class="line">        <span class="keyword">if</span> (mFormat) &#123;</span><br><span class="line">            StringBuilder text = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="comment">// 这里将空格删去</span></span><br><span class="line">            text.append(editable.toString().replace(<span class="string">" "</span>, <span class="string">""</span>));</span><br><span class="line">            <span class="keyword">int</span> length = text.length();</span><br><span class="line">            <span class="keyword">int</span> sum = (length % <span class="number">2</span> == <span class="number">0</span>) ? (length / <span class="number">2</span>) - <span class="number">1</span> : (length / <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> offset = <span class="number">2</span>, index = <span class="number">0</span>; index &lt; sum; offset += <span class="number">3</span>, index++) &#123;</span><br><span class="line">                text.insert(offset, <span class="string">" "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mLastText = text.toString();</span><br><span class="line">            mEditText.setText(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.i(TAG, e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="nfccomm">2. NfcComm</h4>
<p>这个类定义了nfc apdu数据的多种数据类型.</p>
<h4 id="rulematching">3. RuleMatching</h4>
<ol type="1">
<li><p>下示代码时修改UID的一个函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeUIDRule</span><span class="params">(NfcComm anticol)</span></span>&#123;</span><br><span class="line">    String UID = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ac.equals(MitMAction.RandomAnticol)) &#123;</span><br><span class="line">        <span class="comment">// 随机生成4字节的数据作为UID</span></span><br><span class="line">        UID = Utils.randomHexString(<span class="number">4</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ac.equals(MitMAction.SelfDefineAnticol)) &#123;</span><br><span class="line">        UID = mUID;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (UID != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mConfig = Utils.relaceBytesFromArray(anticol.getConfig().build(),</span><br><span class="line">                                             Utils.toBytes(UID),</span><br><span class="line">                                             <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;(<span class="keyword">byte</span>)<span class="number">0x33</span>,</span><br><span class="line">                                                        (<span class="keyword">byte</span>)<span class="number">0x04</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>以下是识别来自card的指令的函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">compReaderCommFromDb</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    RuleListStorage db = <span class="keyword">new</span> RuleListStorage(RelayFragment.getInstance().getContext());</span><br><span class="line">    List&lt;RuleListItem&gt; items = db.getAll();</span><br><span class="line">    <span class="comment">// 遍历每个位于规则数据库的item</span></span><br><span class="line">    <span class="keyword">for</span> (RuleListItem item: items) &#123;</span><br><span class="line">        <span class="comment">// 如果当前的item的state为1, 则将mChangeCardComm赋值</span></span><br><span class="line">        <span class="keyword">if</span> (item.getSelect() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Utils.bytesToHex(nfcdata.getData()).indexOf(</span><br><span class="line">                Utils.bytesToHex(item.getReaderComm().getData())) == <span class="number">0</span>) &#123;</span><br><span class="line">                mChangeCardComm = item.getCardComm().getData();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mChangeCardComm = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (item.getSelect() == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 通过读卡器的数据来修改读卡器命令</span></span><br><span class="line">            <span class="keyword">if</span> (Utils.bytesToHex(nfcdata.getData()).indexOf(</span><br><span class="line">                Utils.bytesToHex(item.getReaderComm().getData())) == <span class="number">0</span>) &#123;</span><br><span class="line">                mChangeHceComm = item.getCardComm().getData();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mChangeHceComm = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>以下三个函数时中间人apdu数据重要函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改card返回的apdu数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> NfcComm <span class="title">changeCardData</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//        Log.i(TAG,"Card: " + Utils.bytesToHex(nfcdata.getData()));</span></span><br><span class="line">    <span class="keyword">if</span> (mChangeCardComm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//            Log.i(TAG,"Exec: " + Utils.bytesToHex(mChangeCardComm));</span></span><br><span class="line">        nfcdata.setData(mChangeCardComm);</span><br><span class="line">        mChangeCardComm = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nfcdata;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 修改读卡器发送的apdu数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> NfcComm <span class="title">changeHCEData</span><span class="params">(NfcComm nfcdata)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//        Log.i(TAG,"HCE : " + Utils.bytesToHex(nfcdata.getData()));</span></span><br><span class="line">    compReaderCommFromDb(nfcdata);</span><br><span class="line">    <span class="keyword">if</span> (mChangeHceComm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        nfcdata.setData(mChangeHceComm);</span><br><span class="line">        mChangeHceComm = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nfcdata;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 修改uid</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> NfcComm <span class="title">changeAnticolData</span><span class="params">(NfcComm anticol)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (anticol.getType() == NfcComm.Type.AnticolBytes) &#123;</span><br><span class="line">        changeUIDRule(anticol);</span><br><span class="line">        <span class="keyword">if</span> (mConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">            anticol = <span class="keyword">new</span> NfcComm(<span class="keyword">new</span> ConfigBuilder(mConfig));</span><br><span class="line">            mConfig = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> anticol;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="utils">4. Utils</h4>
<p>这个类含有全局需要的处理数据的函数. 大部分已注释了解释的函数不在列举. 举一个简单的函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个函数读取特定目录下的所有文件, 并返回文件名列表</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title">listDir</span><span class="params">(String path)</span></span>&#123;</span><br><span class="line">    ArrayList&lt;String&gt; myFile = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    String realPath=Environment.getExternalStorageDirectory().toString()+<span class="string">"/MTYReader/"</span>+path;</span><br><span class="line">    Log.i(<span class="string">"listDir"</span>,realPath);</span><br><span class="line">    File file=<span class="keyword">new</span> File(realPath);</span><br><span class="line">    File[] files=file.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt;files.length;i++)&#123;</span><br><span class="line">        myFile.add(files[i].getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> myFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/09/09/NFC开发笔记/">NFC开发笔记</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 killshadow 的个人博客">killshadow</a></p>
        <p><span>发布时间:</span>2018年09月09日 - 00时00分</p>
        <p><span>最后更新:</span>2018年10月25日 - 14时45分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/09/09/NFC开发笔记/" title="NFC开发笔记">http://www.killshadow.xyz/2018/09/09/NFC开发笔记/</a>
            <span class="copy-path" data-clipboard-text="原文: http://www.killshadow.xyz/2018/09/09/NFC开发笔记/　　作者: killshadow" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2018/10/10/1.1-菜鸟学PWN之栈溢出学习/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          1.1-菜鸟学PWN之栈溢出学习
        
      </div>
    </a>
  
  
    <a href="/2018/06/15/基于主机的卡模拟(HCE)概述/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">基于主机的卡模拟(HCE)概述</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#x00-概述"><span class="toc-number">1.</span> <span class="toc-text">0x00 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x01-视图模块之fragmentactivity"><span class="toc-number">2.</span> <span class="toc-text">0x01 视图模块之Fragment/Activity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#adapter"><span class="toc-number">2.1.</span> <span class="toc-text">Ⅰ. adapter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#listviewadapter"><span class="toc-number">2.1.1.</span> <span class="toc-text">1. ListViewAdapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mitmitemadapter"><span class="toc-number">2.1.2.</span> <span class="toc-text">2. MitmItemAdapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#muladapter"><span class="toc-number">2.1.3.</span> <span class="toc-text">3. MulAdapter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fragment"><span class="toc-number">2.2.</span> <span class="toc-text">Ⅱ. Fragment</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#clonefragment"><span class="toc-number">2.2.1.</span> <span class="toc-text">1. CloneFragment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#enablenfcdialog"><span class="toc-number">2.2.2.</span> <span class="toc-text">2. EnablenfcDialog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hcefragment"><span class="toc-number">2.2.3.</span> <span class="toc-text">4. HceFragment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loggingdetailfragment"><span class="toc-number">2.2.4.</span> <span class="toc-text">5. LoggingDetailFragment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loggingfragment"><span class="toc-number">2.2.5.</span> <span class="toc-text">6. LoggingFragment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mitmfragment"><span class="toc-number">2.2.6.</span> <span class="toc-text">7. MitmFragment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#relayfragment"><span class="toc-number">2.2.7.</span> <span class="toc-text">8. RelayFragment</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tablayout-tablogic"><span class="toc-number">2.3.</span> <span class="toc-text">Ⅲ. tabLayout &amp; tabLogic</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pageradapter"><span class="toc-number">2.3.1.</span> <span class="toc-text">PagerAdapter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#activity"><span class="toc-number">2.4.</span> <span class="toc-text">Ⅳ. Activity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#aboutworkaroundactivity"><span class="toc-number">2.4.1.</span> <span class="toc-text">1. AboutWorkaroundActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#editactivity"><span class="toc-number">2.4.2.</span> <span class="toc-text">2. EditActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#logactivity"><span class="toc-number">2.4.3.</span> <span class="toc-text">3. LogActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mainactivity"><span class="toc-number">2.4.4.</span> <span class="toc-text">4. MainActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#settingactivity"><span class="toc-number">2.4.5.</span> <span class="toc-text">5. SettingActivity</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x02-network模块"><span class="toc-number">3.</span> <span class="toc-text">0x02 network模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#c2cc2smeta"><span class="toc-number">3.1.</span> <span class="toc-text">Ⅰ. c2c/c2s/meta</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#highlevelprotobufhandler"><span class="toc-number">3.2.</span> <span class="toc-text">Ⅱ. HighLevelProtobufHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lowleveltcphandler"><span class="toc-number">3.3.</span> <span class="toc-text">Ⅲ. LowLevelTCPHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#protobufcallback"><span class="toc-number">3.4.</span> <span class="toc-text">Ⅳ. ProtobufCallback</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x03-nfc模块"><span class="toc-number">4.</span> <span class="toc-text">0x03 nfc模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#config"><span class="toc-number">4.1.</span> <span class="toc-text">Ⅰ. config</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hce"><span class="toc-number">4.2.</span> <span class="toc-text">Ⅱ. hce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reader"><span class="toc-number">4.3.</span> <span class="toc-text">Ⅲ. reader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nfcmanager"><span class="toc-number">4.4.</span> <span class="toc-text">Ⅳ. NfcManager</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x04-util"><span class="toc-number">5.</span> <span class="toc-text">0x04 util</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#db"><span class="toc-number">5.1.</span> <span class="toc-text">Ⅰ. db</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cloneliststorage"><span class="toc-number">5.1.1.</span> <span class="toc-text">1. CloneListStorage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ruleliststorage"><span class="toc-number">5.1.2.</span> <span class="toc-text">2. RuleListStorage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sessionloggingdbhelper"><span class="toc-number">5.1.3.</span> <span class="toc-text">3. SessionLoggingDbHelper</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filter"><span class="toc-number">5.2.</span> <span class="toc-text">Ⅱ. filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他"><span class="toc-number">5.3.</span> <span class="toc-text">Ⅲ. 其他</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#customtextwatcher"><span class="toc-number">5.3.1.</span> <span class="toc-text">1. CustomTextWatcher</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nfccomm"><span class="toc-number">5.3.2.</span> <span class="toc-text">2. NfcComm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rulematching"><span class="toc-number">5.3.3.</span> <span class="toc-text">3. RuleMatching</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#utils"><span class="toc-number">5.3.4.</span> <span class="toc-text">4. Utils</span></a></li></ol></li></ol></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>





<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/10/10/1.1-菜鸟学PWN之栈溢出学习/" title="上一篇: 1.1-菜鸟学PWN之栈溢出学习">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2018/06/15/基于主机的卡模拟(HCE)概述/" title="下一篇: 基于主机的卡模拟(HCE)概述">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/04/深度学习理论基础/">深度学习理论基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/隐写术(三)--JPEG隐写分析特征算法与理论/">隐写术(三)--JPEG隐写分析特征算法与理论</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/隐写术(二)--传统数字图像隐写算法/">隐写术(二)--传统数字图像隐写算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/隐写术(一)--简介/">隐写术(一)--简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/24/Ubuntu18.04+8x1080ti爆破环境从零搭建/">Ubuntu18.04+8x1080ti爆破环境从零搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/10/1.1-菜鸟学PWN之栈溢出学习/">1.1-菜鸟学PWN之栈溢出学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/09/NFC开发笔记/">NFC开发笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/15/基于主机的卡模拟(HCE)概述/">基于主机的卡模拟(HCE)概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/10/某aes变种题分析/">某AES变种题分析</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 killshadow
            </div>
            <div class="footer-right">
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 96;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


    <script type="text/javascript">
      window.onload = function(){
        document.getElementById("search").onclick = function(){
            console.log("search")
            search();
        }
      }
      function search(){
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
        (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
        e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','A1Pz-LKMXbrzcFg2FWi6','2.0.0');
      }
    </script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>